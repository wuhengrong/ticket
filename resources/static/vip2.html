<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬¡æ•°ä¿¡æ¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1, h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .user-info {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .guide-section {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }
        
        .guide-title {
            font-size: 16px;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 10px;
        }
        
        .guide-step {
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
            font-size: 14px;
        }
		
		.guide-step-red {
		    margin-bottom: 8px;
		    padding-left: 15px;
		    position: relative;
		    font-size: 14px;
		    color: #ff0000; /* æ·»åŠ çº¢è‰²å­—ä½“ */
		    font-weight: bold; /* å¯é€‰ï¼šåŠ ç²—å­—ä½“æ›´é†’ç›® */
		}
        
        .guide-step:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #ff9800;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .ticket-info {
            margin-bottom: 15px;
        }
        
        .ticket-info p {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .card-details {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .status-available {
            background: #d4edda;
            color: #155724;
        }
        
        .status-in-use {
            background: #fff3cd;
            color: #856404;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:hover {
            background: #f9f9f9;
        }
        
        .no-tickets {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #3498db;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #fadbd8;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .time-suggestion {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .time-btn {
            flex: 1;
            background: #ecf0f1;
            border: none;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .time-btn:hover {
            background: #d5dbdb;
        }

        .card-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

		.info-row {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    margin: 12px 0;
		    padding: 10px;
		    background: rgba(255, 255, 255, 0.1);
		    border-radius: 8px;
		}

		.info-label {
		    font-size: 14px;
		    opacity: 0.9;
		    min-width: 80px;
		    text-align: left;
		}

		.info-value {
		    font-size: 16px;
		    font-weight: bold;
		    font-family: monospace;
		    flex: 1;
		    text-align: center;
		    margin: 0 10px;
		}


        .user-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .ride-count {
            font-size: 18px;
            color: #e74c3c;
            font-weight: bold;
        }
		
		.toast {
		    position: fixed;
		    top: 20px;
		    left: 50%;
		    transform: translateX(-50%);
		    background: rgba(0, 0, 0, 0.8);
		    color: white;
		    padding: 12px 20px;
		    border-radius: 6px;
		    font-size: 14px;
		    z-index: 1000;
		    opacity: 0;
		    transition: opacity 0.3s;
		    pointer-events: none;
		}

		.toast.show {
		    opacity: 1;
		}

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }
		
		/* æˆ–è€…ä¸ºé”™è¯¯å®¹å™¨æ·»åŠ ä¸Šéƒ¨é—´è· */
		#errorContainer {
		    margin-top: 20px;
		}

        /* æ–°å¢ï¼šäºŒç»´ç ä¹˜è½¦æ›¿ä»£æ–¹æ¡ˆæ ·å¼ */
        .qr-alternative {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .method-title {
            color: #856404;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: left;
        }

        .step {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
            color: #856404;
            text-align: left;
        }

        .step:before {
            content: "â€¢";
            position: absolute;
            left: 8px;
            color: #856404;
        }

        .qr-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .qr-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .note {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
            border: 1px solid #f5c6cb;
            text-align: left;
        }
    </style>
</head>
<body>
   
    <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
    <div class="container" id="userInfoContainer">
        <div class="user-info">
            <h2>æ¬¡å¡ä¿¡æ¯</h2>
            <div class="user-name" id="vipCustomerName">-</div>
            <p>å‰©ä½™ä¹˜è½¦æ¬¡æ•°: <span class="ride-count" id="rideCount">-</span> æ¬¡</p>
        </div>
        
        <!-- æ·»åŠ çš„ä½¿ç”¨æŒ‡å— -->
        <div class="guide-section">
            <div class="guide-title">ä½¿ç”¨æŒ‡å—</div>
            
            <div style="margin-bottom: 15px;">
                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">è·å–è´¦å·ï¼š</div>
                <div class="guide-step">è¾“å…¥èµ·å§‹ç«™ç‚¹å’Œç›®çš„ç«™ç‚¹ï¼ŒæŸ¥è¯¢å¯ç”¨ç¥¨</div>
                <div class="guide-step">ç‚¹å‡»"ä½¿ç”¨æ­¤ç¥¨å¡"è·å–è´¦å·å¯†ç </div>
                <div class="guide-step-red">ä¹˜è½¦ç»“æŸåç‚¹å‡»"å½’è¿˜ç¥¨å¡",å¦åˆ™è¶…æ—¶å°†å¯¼è‡´æ¬¡æ•°å¼‚å¸¸</div>
            </div>
            
            <div>
                <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">ç™»å½•æ‰«ç ï¼š</div>
                <div class="guide-step">æ‰“å¼€'æ·±åœ³åœ°é“'appï¼Œç‚¹å‡»'ç«‹å³ç™»å½•-åˆ‡æ¢è´¦å·-å¯†ç ç™»å½•'</div>
                <div class="guide-step">ç™»å½•åé€‰æ‹©'é¦–é¡µ-è™šæ‹Ÿç¥¨-æˆ‘çš„ç¥¨å¡-ä½¿ç”¨'</div>
            </div>
        </div>
    </div>

    <!-- ç¥¨åŠ¡æŸ¥è¯¢ -->
    <div class="container" id="ticketQueryContainer">
        <h2>ä¹˜è½¦æŸ¥è¯¢</h2>
        
        <form id="ticketForm">
            <div class="form-group">
                <label for="startStation">èµ·å§‹ç«™ç‚¹</label>
                <input type="text" id="startStation" placeholder="è¾“å…¥èµ·å§‹ç«™ç‚¹">
              
            </div>
            
            <div class="form-group">
                <label for="endStation">ç›®çš„ç«™ç‚¹</label>
                <input type="text" id="endStation" placeholder="è¾“å…¥ç›®çš„ç«™ç‚¹" >
            </div>
            
            <div class="form-group">
                <label for="travelTime">ä¹˜è½¦æ—¶é—´</label>
                <input type="datetime-local" id="travelTime">
                <div class="time-suggestion">
                    <button type="button" class="time-btn" onclick="setTime('now')">ç°åœ¨</button>
                    <button type="button" class="time-btn" onclick="setTime('15min')">15åˆ†é’Ÿå</button>
                    <button type="button" class="time-btn" onclick="setTime('30min')">30åˆ†é’Ÿå</button>
                </div>
            </div>
            
            <button type="button" class="btn" id="searchBtn" onclick="searchTickets()">æŸ¥è¯¢å¯ç”¨ç¥¨</button>
        </form>
		<!-- é”™è¯¯æç¤º -->
		<div id="errorContainer" class="error hidden"></div>

        <!-- äºŒç»´ç ä¹˜è½¦æ›¿ä»£æ–¹æ¡ˆ - åˆå§‹éšè— -->
        <div id="qrAlternativeContainer" class="qr-alternative hidden">
            <div class="method-title">ğŸ”— äºŒç»´ç ä¹˜è½¦ï¼š</div>
            <div class="step">ç‚¹å‡»"å‡†å¤‡ä¹˜è½¦"æŒ‰é’®</div>
            <div class="step">ç‚¹å‡»"ç¡®è®¤"</div>
            <div class="step">ç‚¹å‡»"è¿›ç«™ æ‰£é™¤ä¸€æ¬¡ä¹˜è½¦æ¬¡æ•°"</div>
            <button id="qr-code-button" class="qr-button" onclick="openQRCodePage()">
                ğŸ“± ç‚¹å‡»äºŒç»´ç ä¹˜è½¦
            </button>
            <div class="note">
                ğŸ’¡ å¤‡æ³¨ï¼šæå‰2åˆ†é’Ÿç‚¹å‡»è¿›ç«™å†æ‰«ç è¿›ç«™æ›´å¥½(æœ€å¤šåªèƒ½æå‰10åˆ†é’Ÿå ç¥¨)
            </div>
        </div>

		<!-- ä¿®æ”¹åçš„ç¥¨åŠ¡æŸ¥è¯¢ç»“æœæ˜¾ç¤º -->
		<div id="searchResult" style="display: none;">
		    <div class="card-display">
		        <div class="card-title">ä¸ºæ‚¨æ‰¾åˆ°æœ€ä½³åŒ¹é…ç¥¨å¡</div>
		        
		        <!-- ç¥¨å¡å·ç è¡Œ - é»˜è®¤æ˜¾ç¤ºå¸¦æ©ç çš„ä¿¡æ¯ -->
		        <div class="info-row">
		            <span class="info-label">ç™»å½•å·</span>
		            <span class="info-value" id="displayCardNumber">-</span>
		        </div>
		        
		        <!-- ç¥¨å¡å¯†ç è¡Œ - é»˜è®¤æ˜¾ç¤ºå¸¦æ©ç çš„ä¿¡æ¯ -->
		        <div class="info-row">
		            <span class="info-label">ç™»å½•ç </span>
		            <span class="info-label" id="displayCardPassword">-</span>
		        </div>
		    </div>

		    <button class="btn btn-success" id="useTicketBtn" onclick="useTicket()">ä½¿ç”¨æ­¤ç¥¨å¡</button>
		</div>
		
    </div>
    
    <!-- å½“å‰ä½¿ç”¨ä¸­ -->
	<div class="container" id="inUseContainer">
	    <h2>å½“å‰ä½¿ç”¨ä¸­</h2>
	    <div class="status status-in-use">ç¥¨åŠ¡ä½¿ç”¨ä¸­</div>
	    <div class="ticket-info">
	        <div class="card-details">
	            <!-- åœ¨ä½¿ç”¨ä¸­ç•Œé¢å®Œæ•´æ˜¾ç¤ºå¡å·å’Œå¯†ç  -->
	            <p><strong>ç¥¨å¡å·ç ï¼š</strong><span id="currentCardNumber">-</span></p>
	            <p><strong>ç¥¨å¡å¯†ç ï¼š</strong><span id="currentCardPassword">-</span></p>
	        </div>
	        <p><strong>èµ·å§‹ç«™ï¼š</strong><span id="currentStart">-</span></p>
	        <p><strong>ç›®çš„ç«™ï¼š</strong><span id="currentEnd">-</span></p>
	        <p><strong>ä¹˜è½¦æ—¶é—´ï¼š</strong><span id="currentTime">-</span></p>
	        <p><strong>é¢„ä¼°å‡ºç«™æ—¶é—´ï¼š</strong><span id="currentEstimatedTime">-</span></p>
	    </div>
	    
	    <button class="btn btn-danger" id="returnTicketBtn" onclick="returnTicket()">å½’è¿˜ç¥¨å¡</button>
	    <div class="debug-info" id="returnDebugInfo" style="display: none;"></div>
	</div>
    
    <!-- ä¹˜è½¦å†å² -->
    <div class="container" id="historyContainer">
        <h2>ä¹˜è½¦å†å²è®°å½•</h2>
        <div id="historyList">
            <!-- åŠ¨æ€ç”Ÿæˆå†å²è®°å½• -->
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTicket = null;
        let currentCustomer = null;
        let urlParams = {};
        let activeTicketInfo = null;
        let currentTicketCard = null;

        // å­—ç¬¦ä¸²æ©ç å‡½æ•° - ä¸­é—´3ä½æ›¿æ¢ä¸º***
        function maskString(str) {
            if (!str || str.length < 6) return str;
            
            const length = str.length;
            const maskCount = 3; // å›ºå®šæ›¿æ¢3ä½
            const startIndex = Math.floor((length - maskCount) / 2);
            const endIndex = startIndex + maskCount;
            
            const prefix = str.substring(0, startIndex);
            const suffix = str.substring(endIndex);
            const stars = '*'.repeat(maskCount);
            
            return prefix + stars + suffix;
        }
        
        // APIè°ƒç”¨å‡½æ•°
        const apiClient = {
            // è·å–å®¢æˆ·ä¿¡æ¯
            async getCustomerInfo(vipUrl) {
                try {
                    const response = await fetch(`/api/vip/customer/${encodeURIComponent(vipUrl)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    throw error;
                }
            },
            
            // æœç´¢ç¥¨å¡
            async searchTickets(searchData) {
                try {
                    const response = await fetch('/api/vip/tickets/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(searchData)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('æœç´¢ç¥¨å¡å¤±è´¥:', error);
                    throw error;
                }
            },
            
            // ä½¿ç”¨ç¥¨å¡
            async useTicket(useData) {
                try {
                    const response = await fetch('/api/vip/tickets/use', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(useData)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('ä½¿ç”¨ç¥¨å¡å¤±è´¥:', error);
                    throw error;
                }
            },
            
            // å½’è¿˜ç¥¨å¡
            async returnTicket(cardId, alightingStation, customerId) {
                try {
                    console.log('å½’è¿˜ç¥¨å¡è¯·æ±‚å‚æ•°:', {
                        cardId: cardId,
                        customerId: customerId,
                        alightingStation: alightingStation
                    });

                    const url = `/api/vip/tickets/return/${cardId}?alightingStation=${encodeURIComponent(alightingStation)}&customerId=${customerId}`;
                    console.log('è¯·æ±‚URL:', url);

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    console.log('å“åº”çŠ¶æ€:', response.status);
                    
                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            const errorResponse = await response.json();
                            errorMessage = errorResponse.message || errorMessage;
                        } catch (e) {
                            // å¿½ç•¥JSONè§£æé”™è¯¯
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const result = await response.json();
                    console.log('å“åº”ç»“æœ:', result);
                    return result;
                    
                } catch (error) {
                    console.error('å½’è¿˜ç¥¨å¡å¤±è´¥:', error);
                    throw error;
                }
            },

            // è·å–å®¢æˆ·å½“å‰è¿›è¡Œä¸­çš„ç¥¨åŠ¡
            async getActiveTicket(customerId) {
                try {
                    const response = await fetch(`/api/vip/customer/${customerId}/active-ticket`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            return null;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('è·å–è¿›è¡Œä¸­ç¥¨åŠ¡å¤±è´¥:', error);
                    return null;
                }
            },

            // æ ¹æ®codeè·å–ç¥¨å¡ä¿¡æ¯
            async getTicketCardByCode(code) {
                try {
                    const response = await fetch(`/api/ticket-cards/code/${code}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('è·å–ç¥¨å¡ä¿¡æ¯å¤±è´¥:', error);
                    throw error;
                }
            }
        };

        // å·¥å…·å‡½æ•°
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorContainer').classList.add('hidden');
        }

        function showDebugInfo(info) {
            const debugInfo = document.getElementById('returnDebugInfo');
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
        }

        function hideDebugInfo() {
            document.getElementById('returnDebugInfo').style.display = 'none';
        }

        // æ˜¾ç¤ºäºŒç»´ç ä¹˜è½¦æ›¿ä»£æ–¹æ¡ˆ
        function showQRAlternative() {
            document.getElementById('qrAlternativeContainer').classList.remove('hidden');
        }

        // éšè—äºŒç»´ç ä¹˜è½¦æ›¿ä»£æ–¹æ¡ˆ
        function hideQRAlternative() {
            document.getElementById('qrAlternativeContainer').classList.add('hidden');
        }

		function setTime(type) {
		    const now = new Date();
		    let timeInput = document.getElementById('travelTime');
		    
		    const beijingOffset = 8 * 60 * 60 * 1000;
		    const beijingTime = new Date(now.getTime() + beijingOffset);
		    
		    if (type === 'now') {
		        beijingTime.setMinutes(beijingTime.getMinutes() + 5);
		    } else if (type === '15min') {
		        beijingTime.setMinutes(beijingTime.getMinutes() + 15);
		    } else if (type === '30min') {
		        beijingTime.setMinutes(beijingTime.getMinutes() + 30);
		    }
		    
		    const formatted = beijingTime.toISOString().slice(0, 16);
		    timeInput.value = formatted;
		    
		    document.querySelectorAll('.time-btn').forEach(btn => {
		        btn.classList.remove('active');
		    });
		    
		    const buttons = document.querySelectorAll('.time-btn');
		    buttons.forEach(btn => {
		        if (btn.textContent === getButtonText(type)) {
		            btn.classList.add('active');
		        }
		    });
		}

		function getButtonText(type) {
		    const textMap = {
		        'now': 'ç°åœ¨',
		        '15min': '15åˆ†é’Ÿå',
		        '30min': '30åˆ†é’Ÿå'
		    };
		    return textMap[type] || type;
		}

        function formatDateTime(datetimeStr) {
            if (!datetimeStr) return '-';
            const date = new Date(datetimeStr);
            return `${date.getFullYear()}-${padZero(date.getMonth()+1)}-${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        }

        function padZero(num) {
            return num < 10 ? '0' + num : num;
        }

		// Toastæç¤ºå‡½æ•°
		function showToast(message) {
		    let toast = document.getElementById('toast');
		    if (!toast) {
		        toast = document.createElement('div');
		        toast.id = 'toast';
		        toast.style.cssText = `
		            position: fixed;
		            top: 20px;
		            left: 50%;
		            transform: translateX(-50%);
		            background: rgba(0, 0, 0, 0.8);
		            color: white;
		            padding: 12px 20px;
		            border-radius: 6px;
		            font-size: 14px;
		            z-index: 1000;
		            opacity: 0;
		            transition: opacity 0.3s;
		            pointer-events: none;
		        `;
		        document.body.appendChild(toast);
		    }
		    
		    toast.textContent = message;
		    toast.style.opacity = '1';
		    
		    setTimeout(() => {
		        toast.style.opacity = '0';
		    }, 2000);
		}

        // è§£æURLå‚æ•°
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                uId: urlParams.get('uId'),
                gId: urlParams.get('gId'),
                code: urlParams.get('code')
            };
        }

        // éªŒè¯URLå‚æ•°
        function validateUrlParams(params) {
            if (!params.uId || !params.gId || !params.code) {
                return false;
            }
            return params.uId.length > 0 && params.gId.length > 0 && params.code.length > 0;
        }

        // æ„å»ºVIP URL
        function buildVipUrl(uId, gId, code) {
            return `vip.html?uId=${uId}&gId=${gId}&code=${code}`;
        }

        // æ‰“å¼€äºŒç»´ç ä¹˜è½¦é¡µé¢
        function openQRCodePage() {
            if (currentTicketCard && currentTicketCard.cardUrl) {
                window.open(currentTicketCard.cardUrl, '_blank');
            } else {
                showError('ç¥¨å¡é“¾æ¥æ— æ•ˆ');
            }
        }

		// åˆå§‹åŒ–é¡µé¢
		async function initializePage() {
		    try {
		        hideError();
		        hideDebugInfo();
		        hideQRAlternative();
		        
		        urlParams = parseUrlParams();
		        
		        if (!validateUrlParams(urlParams)) {
		            showError('æ— æ•ˆçš„è®¿é—®é“¾æ¥ï¼Œè¯·æ£€æŸ¥URLå‚æ•°æ˜¯å¦æ­£ç¡®');
		            disableAllFeatures();
		            return;
		        }
		        
		        const vipUrl = buildVipUrl(urlParams.uId, urlParams.gId, urlParams.code);
		        const customerData = await apiClient.getCustomerInfo(vipUrl);
		        
		        if (customerData && customerData.customer) {
		            currentCustomer = customerData.customer;
		            displayCustomerInfo(currentCustomer);
		            
		            if (customerData.history) {
		                displayHistory(customerData.history);
		            }
		            
		            if (customerData.activeTicket && customerData.activeTicket.hasActiveTicket) {
		                showInUseSection(customerData.activeTicket);
		            } else {
		                hideInUseSection();
		            }
		            
		            // åŠ è½½ç¥¨å¡ä¿¡æ¯ç”¨äºäºŒç»´ç ä¹˜è½¦
		            try {
		                currentTicketCard = await apiClient.getTicketCardByCode(urlParams.code);
		            } catch (error) {
		                console.warn('åŠ è½½ç¥¨å¡ä¿¡æ¯å¤±è´¥ï¼ŒäºŒç»´ç ä¹˜è½¦åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨:', error);
		            }
		            
		        } else {
		            showError('æ— æ³•è·å–å®¢æˆ·ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥URLå‚æ•°');
		            disableAllFeatures();
		        }
		        
		    } catch (error) {
		        console.error('åˆå§‹åŒ–é¡µé¢å¤±è´¥:', error);
		        showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
		        disableAllFeatures();
		    }
		}

        // æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯
        function displayCustomerInfo(customer) {
            document.getElementById('vipCustomerName').textContent = customer.userName || '-';
            document.getElementById('rideCount').textContent = customer.rideCount || 0;
            updateUIByRideCount(customer.rideCount);
        }

        // æ ¹æ®æ¬¡å¡æ¬¡æ•°æ›´æ–°ç•Œé¢
        function updateUIByRideCount(rideCount) {
            const searchBtn = document.getElementById('searchBtn');
            if (rideCount <= 0) {
                searchBtn.disabled = true;
                searchBtn.textContent = 'æ¬¡å¡æ¬¡æ•°ä¸è¶³';
                showError('æ‚¨çš„æ¬¡å¡æ¬¡æ•°å·²ç”¨å®Œï¼Œæ— æ³•æŸ¥è¯¢ç¥¨åŠ¡');
            } else {
                searchBtn.disabled = false;
                searchBtn.textContent = 'æŸ¥è¯¢å¯ç”¨ç¥¨';
                hideError();
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="no-tickets"><p>æš‚æ— ä¹˜è½¦è®°å½•</p></div>';
                return;
            }
            
            let html = '';
            history.forEach(record => {
                const boardingTime = formatDateTime(record.boardingTime);
                const alightingTime = record.alightingTime ? formatDateTime(record.alightingTime) : 'ä½¿ç”¨ä¸­';
                const status = record.alightingTime ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
                
                html += `
                    <div class="history-item">
                        <p><strong>${record.boardingStation} â†’ ${record.alightingStation || 'æœªå‡ºç«™'}</strong></p>
                        <p>è¿›ç«™: ${boardingTime} | å‡ºç«™: ${alightingTime}</p>
                        <p>çŠ¶æ€: ${status}</p>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

		// æ˜¾ç¤ºä½¿ç”¨ä¸­ç•Œé¢
		function showInUseSection(ticketInfo) {
		    console.log('æ˜¾ç¤ºä½¿ç”¨ä¸­ç•Œé¢ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®:', ticketInfo);
		    
		    document.getElementById('ticketQueryContainer').style.display = 'none';
		    document.getElementById('inUseContainer').style.display = 'block';
		    document.getElementById('historyContainer').style.display = 'block';
		    
		    if (ticketInfo) {
		        const cardPassword = ticketInfo.cardPassword || 
		                           (currentTicket && currentTicket.cardPassword) || 
		                           '-';
		        
		        // åœ¨ä½¿ç”¨ä¸­ç•Œé¢æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
		        document.getElementById('currentCardNumber').textContent = ticketInfo.cardNumber || '-';
		        document.getElementById('currentCardPassword').textContent = cardPassword;
		        document.getElementById('currentStart').textContent = ticketInfo.boardingStation || '-';
		        document.getElementById('currentEnd').textContent = ticketInfo.alightingStation || '-';
		        document.getElementById('currentTime').textContent = formatDateTime(ticketInfo.boardingTime) || '-';
		        document.getElementById('currentEstimatedTime').textContent = formatDateTime(ticketInfo.estimatedAlightingTime) || '-';
		        
		        currentTicket = {
		            id: ticketInfo.cardId || currentTicket?.id,
		            cardNumber: ticketInfo.cardNumber || currentTicket?.cardNumber,
		            cardPassword: cardPassword
		        };
		    }
		}

		// éšè—ä½¿ç”¨ä¸­ç•Œé¢
		function hideInUseSection() {
		    document.getElementById('ticketQueryContainer').style.display = 'block';
		    document.getElementById('inUseContainer').style.display = 'none';
		    document.getElementById('historyContainer').style.display = 'block';
		    
		    currentTicket = null;
		    activeTicketInfo = null;
		    hideSearchResult();
		}

        // ç¦ç”¨æ‰€æœ‰åŠŸèƒ½
        function disableAllFeatures() {
            document.getElementById('ticketQueryContainer').style.display = 'none';
            document.getElementById('inUseContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'none';
        }

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        function showSearchResult() {
            document.getElementById('searchResult').style.display = 'block';
        }

        // éšè—æŸ¥è¯¢ç»“æœ
        function hideSearchResult() {
            document.getElementById('searchResult').style.display = 'none';
        }

        // æœç´¢ç¥¨åŠ¡
        async function searchTickets() {
            const startStation = document.getElementById('startStation').value;
            const endStation = document.getElementById('endStation').value;
            const travelTime = document.getElementById('travelTime').value;
            
            if (!startStation || !endStation || !travelTime) {
                showError('è¯·å¡«å†™å®Œæ•´çš„æŸ¥è¯¢ä¿¡æ¯');
                hideQRAlternative();
                return;
            }
            
            if (!currentCustomer) {
                showError('å®¢æˆ·ä¿¡æ¯æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                hideQRAlternative();
                return;
            }
            
            try {
                hideError();
                hideSearchResult();
                hideQRAlternative();
                
                document.getElementById('searchBtn').disabled = true;
                document.getElementById('searchBtn').textContent = 'æŸ¥è¯¢ä¸­...';
                
                const searchData = {
                    boardingStation: startStation,
                    alightingStation: endStation,
                    boardingTime: travelTime,
                    vipCustomerId: currentCustomer.id
                };
                
                const response = await apiClient.searchTickets(searchData);
                
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'æŸ¥è¯¢å¯ç”¨ç¥¨';
                
                if (response.success) {
                    currentTicket = {
                        id: response.matchedCard.id,
                        cardNumber: response.matchedCard.cardNumber,
                        cardPassword: response.matchedCard.cardPassword
                    };
                    
                    console.log('æœç´¢åè®¾ç½®çš„ currentTicket:', currentTicket);
                    
                    // æ˜¾ç¤ºå¸¦æ©ç çš„å¡å·å’Œå¯†ç 
                    displayTicketResult(response);
                    showSearchResult();
                } else {
                    // æŸ¥è¯¢å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’ŒäºŒç»´ç ä¹˜è½¦æ›¿ä»£æ–¹æ¡ˆ
                    showError(response.message || 'æŸ¥è¯¢å¤±è´¥ï¼Œæš‚æ— å¯ç”¨ç¥¨');
                    showQRAlternative();
                }
            } catch (error) {
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'æŸ¥è¯¢å¯ç”¨ç¥¨';
                showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
                showQRAlternative(); // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤ºäºŒç»´ç æ›¿ä»£æ–¹æ¡ˆ
                console.error('æœç´¢ç¥¨åŠ¡å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºç¥¨åŠ¡ç»“æœ - ä¿®æ”¹ä¸ºé»˜è®¤æ˜¾ç¤ºå¸¦æ©ç çš„ä¿¡æ¯
        function displayTicketResult(response) {
            const ticket = response.matchedCard;
            
            // æ˜¾ç¤ºå¸¦æ©ç çš„å¡å·å’Œå¯†ç 
            const maskedCardNumber = maskString(ticket.cardNumber);
            const maskedCardPassword = maskString(ticket.cardPassword);
            
            document.getElementById('displayCardNumber').textContent = maskedCardNumber || '-';
            document.getElementById('displayCardPassword').textContent = maskedCardPassword || '-';
        }

        // ä½¿ç”¨ç¥¨åŠ¡
		async function useTicket() {
		    if (!currentTicket || !currentCustomer) {
		        showError('ç¥¨åŠ¡ä¿¡æ¯æˆ–å®¢æˆ·ä¿¡æ¯ä¸å®Œæ•´');
		        return;
		    }
		    
		    try {
		        hideError();
		        document.getElementById('useTicketBtn').disabled = true;
		        document.getElementById('useTicketBtn').textContent = 'å¤„ç†ä¸­...';
		        
		        const useData = {
		            vipCustomerId: currentCustomer.id,
		            vipCardId: currentTicket.id,
		            boardingStation: document.getElementById('startStation').value,
		            alightingStation: document.getElementById('endStation').value
		        };
		        
		        const response = await apiClient.useTicket(useData);
		        
		        if (response.success) {
		            currentCustomer.rideCount = response.remainingRides;
		            displayCustomerInfo(currentCustomer);
		            showToast('ç¥¨å¡ä¿¡æ¯è·å–æˆåŠŸï¼æ¬¡å¡æ¬¡æ•°å°†åœ¨è¡Œç¨‹ç»“æŸåæ‰£é™¤');
		            hideSearchResult();
		            
		            showInUseSection({
		                cardId: currentTicket.id,
		                cardNumber: currentTicket.cardNumber,
		                cardPassword: currentTicket.cardPassword,
		                boardingStation: useData.boardingStation,
		                alightingStation: useData.alightingStation,
		                boardingTime: new Date().toISOString(),
		                estimatedAlightingTime: response.estimatedAlightingTime
		            });
		            
		        } else {
		            showError('ä½¿ç”¨ç¥¨åŠ¡å¤±è´¥: ' + response.message);
		            document.getElementById('useTicketBtn').disabled = false;
		            document.getElementById('useTicketBtn').textContent = 'ä½¿ç”¨æ­¤ç¥¨å¡';
		        }
		    } catch (error) {
		        console.error('ä½¿ç”¨ç¥¨åŠ¡å¤±è´¥:', error);
		        showError('ä½¿ç”¨ç¥¨åŠ¡å¤±è´¥: ' + error.message);
		        document.getElementById('useTicketBtn').disabled = false;
		        document.getElementById('useTicketBtn').textContent = 'ä½¿ç”¨æ­¤ç¥¨å¡';
		    }
		}

		// å½’è¿˜ç¥¨å¡
		async function returnTicket() {
		    if (!currentTicket || !currentCustomer) {
		        showError('æ²¡æœ‰æ­£åœ¨ä½¿ç”¨çš„ç¥¨å¡æˆ–å®¢æˆ·ä¿¡æ¯');
		        return;
		    }
		    
		    try {
		        hideError();
		        const returnBtn = document.getElementById('returnTicketBtn');
		        returnBtn.disabled = true;
		        returnBtn.textContent = 'å¤„ç†ä¸­...';
		        
		        const alightingStation = document.getElementById('currentEnd').textContent;
		        if (!alightingStation || alightingStation === '-') {
		            showError('å‡ºç«™ç‚¹ä¿¡æ¯ä¸å®Œæ•´');
		            returnBtn.disabled = false;
		            returnBtn.textContent = 'å½’è¿˜ç¥¨å¡';
		            return;
		        }

		        const result = await apiClient.returnTicket(currentTicket.id, alightingStation, currentCustomer.id);
		        
		        if (result.success) {
		            showToast('ç¥¨å¡å·²æˆåŠŸå½’è¿˜ï¼');
		            hideInUseSection();
		            hideSearchResult();
		            document.getElementById('ticketForm').reset();
		            setTime('now');
		            await initializePage();
		            
		        } else {
		            showError('å½’è¿˜ç¥¨å¡å¤±è´¥: ' + result.message);
		            returnBtn.disabled = false;
		            returnBtn.textContent = 'å½’è¿˜ç¥¨å¡';
		        }
		    } catch (error) {
		        console.error('å½’è¿˜ç¥¨å¡å¤±è´¥:', error);
		        const debugInfo = `è¯·æ±‚è¯¦æƒ…:
URL: /api/vip/tickets/return/${currentTicket?.id}
å‚æ•°: alightingStation=${document.getElementById('currentEnd').textContent}&customerId=${currentCustomer?.id}
é”™è¯¯: ${error.message}`;
		        showDebugInfo(debugInfo);
		        showError('å½’è¿˜ç¥¨å¡å¤±è´¥: ' + error.message);
		        document.getElementById('returnTicketBtn').disabled = false;
		        document.getElementById('returnTicketBtn').textContent = 'å½’è¿˜ç¥¨å¡';
		    }
		}

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setTime('now');
            initializePage();
        });
    </script>
</body>
</html>