<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç ä¹˜è½¦</title>
	<style>
	        * {
	            margin: 0;
	            padding: 0;
	            box-sizing: border-box;
	            font-family: 'Helvetica Neue', Arial, sans-serif;
	        }
	        
	        /* å…³é”®ä¿®æ”¹ï¼šè®©é¡µé¢å æ»¡æ•´ä¸ªiframe */
	        html, body {
	            height: 100%;
	            width: 100%;
	            background-color: transparent;
	            overflow: hidden;
	        }
	        
	        body {
	            color: #333;
	            line-height: 1.6;
	            padding: 0;
	            margin: 0;
	            display: flex;
	            flex-direction: column;
	            min-height: 100vh;
	        }
	        
	        /* å…³é”®ä¿®æ”¹ï¼šå®¹å™¨å æ»¡æ•´ä¸ªé¡µé¢ */
	        .container {
	            background: white;
	            border-radius: 12px;
	            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	            padding: 0px;
	            flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
	            display: flex;
	            flex-direction: column;
	            height: 100%; /* å æ»¡çˆ¶å®¹å™¨é«˜åº¦ */
	            width: 100%; /* å æ»¡çˆ¶å®¹å™¨å®½åº¦ */
	            margin: 0; /* ç§»é™¤å¤–è¾¹è· */
	        }
	        
	        .qr-alternative {
	            background: #fff3cd;
	            border: 1px solid #ffeaa7;
	            border-radius: 8px;
	            padding: 20px;
	            text-align: center;
	            flex: 1; /* å æ»¡å®¹å™¨ */
	            display: flex;
	            flex-direction: column;
	            justify-content: space-between;
	            height: 100%; /* å æ»¡çˆ¶å®¹å™¨ */
	            min-height: 0; /* é˜²æ­¢flexé¡¹ç›®æº¢å‡º */
	        }
	        
	        .method-title {
	            color: #856404;
	            font-weight: bold;
	            margin-bottom: 15px;
	            font-size: 16px;
	            text-align: left;
	        }
	        
	        .step {
	            margin: 8px 0;
	            padding-left: 20px;
	            position: relative;
	            color: #856404;
	            text-align: left;
	        }
	        
	        .step:before {
	            content: "â€¢";
	            position: absolute;
	            left: 8px;
	            color: #856404;
	        }
	        
	        .qr-button {
	            background: linear-gradient(135deg, #3498db, #2980b9);
	            color: white;
	            border: none;
	            padding: 12px 25px;
	            border-radius: 8px;
	            font-size: 16px;
	            font-weight: bold;
	            cursor: pointer;
	            transition: all 0.3s ease;
	            margin: 15px 0;
	            width: 100%;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            gap: 8px;
	            flex-shrink: 0;
	        }
	        
	        .qr-button:hover {
	            transform: translateY(-2px);
	            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
	        }
	        
	        .qr-button:disabled {
	            background: #bdc3c7;
	            cursor: not-allowed;
	            transform: none;
	            box-shadow: none;
	        }
	        
	        .note {
	            background: #f8d7da;
	            color: #721c24;
	            padding: 10px;
	            border-radius: 4px;
	            margin-top: 10px;
	            font-size: 14px;
	            border: 1px solid #f5c6cb;
	            text-align: left;
	            flex-shrink: 0;
	        }
	        
	        .hidden {
	            display: none;
	        }

	        .success-message {
	            background: #d4edda;
	            color: #155724;
	            padding: 16px;
	            border-radius: 8px;
	            margin: 20px 0;
	            border: 1px solid #c3e6cb;
	            display: flex;
	            align-items: flex-start;
	            gap: 12px;
	            flex-shrink: 0;
	            max-width: 100%;
	            overflow: hidden;
	        }

	        .success-icon {
	            font-size: 20px;
	            flex-shrink: 0;
	        }

	        .success-content {
	            flex: 1;
	            min-width: 0;
	            overflow: hidden;
	            text-align: left;
	        }

	        .success-content strong {
	            display: block;
	            margin-bottom: 8px;
	            font-size: 16px;
	            text-align: left;
	        }

	        .success-content p {
	            margin: 4px 0;
	            font-size: 14px;
	            line-height: 1.4;
	        }

	        .error {
	            text-align: center;
	            padding: 20px;
	            color: #e74c3c;
	            background: #fadbd8;
	            border-radius: 8px;
	            margin-bottom: 20px;
	            flex-shrink: 0;
	        }

	        .loading {
	            text-align: center;
	            padding: 10px;
	            color: #3498db;
	            flex-shrink: 0;
	        }

	        /* æ–°å¢ï¼šå†…å®¹åŒºåŸŸï¼Œç¡®ä¿å†…å®¹è‡ªé€‚åº” */
	        .content-area {
	            flex: 1;
	            display: flex;
	            flex-direction: column;
	            justify-content: center;
	            min-height: 0;
	            overflow: hidden;
	        }

	        /* é“¾æ¥æ ·å¼ - æ ¹æ®divå®½åº¦è‡ªåŠ¨æ¢è¡Œ */
	        .card-url {
	            margin-top: 0;
	            font-weight: 500;
	            max-width: 100%;
	            overflow: hidden;
	            text-align: left;
	            word-break: break-all;
	            overflow-wrap: break-word;
	            white-space: normal;
	            line-height: 1.5;
	        }

	        .card-url a {
	            color: #155724;
	            text-decoration: underline;
	            font-weight: 500;
	            word-break: break-all;
	            overflow-wrap: break-word;
	            display: inline;
	            line-height: inherit;
	        }

	        .card-url a:hover {
	            text-decoration: none;
	        }
			
			.method-section {
			    margin-top: 15px;
			    padding: 15px;
			    background: #f8f9fa;
			    border-radius: 8px;
			    border-left: 4px solid #3498db;
			}

			.method-title {
			    color: #2c3e50;
			    font-weight: bold;
			    margin-bottom: 10px;
			    font-size: 16px;
			    text-align: left;
			}

			.step {
			    margin: 8px 0;
			    padding-left: 20px;
			    position: relative;
			    color: #555;
			    text-align: left;
			    font-size: 14px;
			}

			.step:before {
			    content: "â€¢";
			    position: absolute;
			    left: 8px;
			    color: #3498db;
			    font-weight: bold;
			}
	    </style>
</head>
<body>

    <!-- äºŒç»´ç ä¹˜è½¦æ›¿ä»£æ–¹æ¡ˆ -->
    <div class="container">
        <div id="qrAlternativeContainer" class="qr-alternative">
           
            <button id="qr-code-button" class="qr-button">
                ğŸ“± ç‚¹å‡»è·å–äºŒç»´ç é“¾æ¥
            </button>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingContainer" class="loading hidden">
                â³ è¯·æ±‚å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
            </div>
            
            <!-- æˆåŠŸæ¶ˆæ¯ -->
			<!-- æˆåŠŸæ¶ˆæ¯ -->
			<div id="successMessage" class="success-message hidden">
			    
			    <div class="success-content">
			        <strong><span class="success-icon">âœ…</span>æ·»åŠ å®¢æœå¾®ä¿¡ï¼Œäº«å—å®æ—¶æœåŠ¡ï¼šwhengrong</strong>
			        <div id="cardUrl" class="card-url"></div>
			    </div>
			</div>

            <!-- é”™è¯¯æç¤º -->
            <div id="errorContainer" class="error hidden"></div>
            
			<div class="method-section">
			                <div class="method-title">ä¹˜è½¦è¯´æ˜</div>
			                <div class="step">1.ç‚¹å‡»æˆ–å¤åˆ¶ä»¥ä¸Šé“¾æ¥,æŒ‰è¯´æ˜è¿›è¡Œä¹˜è½¦</div>
							<div class="step">2.æå‰3åˆ†é’Ÿç‚¹å‡»è¿›ç«™æ•ˆæœæ›´å¥½</div>
			                <div class="step">3.ç½‘ç»œé—®é¢˜å¯¼è‡´ä¸èƒ½åŠæ—¶è¿›ç«™ï¼Œå¯åˆ·ä¸ªäººå¤‡ç”¨å¡ä¹˜è½¦ï¼ŒåŠæ—¶ç•™è¨€å®¢æœï¼Œä¸æ‰£æ¬¡æ•°</div>

			 </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨ä»çˆ¶çª—å£æ¥æ”¶çš„æ•°æ®
        let parentData = {
            customer: null,
            startStation: '',
            endStation: '',
            urlParams: {}
        };

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
            hideSuccessMessage();
            hideLoading();
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('errorContainer').classList.add('hidden');
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingContainer').classList.remove('hidden');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loadingContainer').classList.add('hidden');
        }

		// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
		// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
		// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
		function showSuccessMessage(cardUrl) {
		    const successMessage = document.getElementById('successMessage');
		    const cardUrlElement = document.getElementById('cardUrl');
		    const methodSection = document.querySelector('.method-section');
		    
		    if (cardUrl) {
		        cardUrlElement.innerHTML = 
		            `<a href="${cardUrl}" target="_blank" title="ç‚¹å‡»æ‰“å¼€é“¾æ¥">
		            ${cardUrl}
		            </a>`;
		    } else {
		        cardUrlElement.textContent = 'é“¾æ¥ç”Ÿæˆå¤±è´¥';
		    }
		    
		    successMessage.classList.remove('hidden');
		    hideError();
		    hideLoading();
		    
		    // ç¡®ä¿æŒ‰é’®è¢«éšè—
		    const qrButton = document.getElementById('qr-code-button');
		    qrButton.style.display = 'none';
		    
		    // æ˜¾ç¤ºæ–¹æ³•è¯´æ˜åŒºåŸŸ
		    if (methodSection) {
		        methodSection.style.display = 'block';
		    }
		    
		    // è§¦å‘å†…å®¹æ£€æŸ¥
		    checkCardUrlContent();
		}
		
		// éšè—æˆåŠŸæ¶ˆæ¯å’Œç›¸å…³å†…å®¹
		function hideSuccessMessage() {
		    const successMessage = document.getElementById('successMessage');
		    const methodSection = document.querySelector('.method-section');
		    
		    successMessage.classList.add('hidden');
		    
		    // éšè—æ–¹æ³•è¯´æ˜åŒºåŸŸ
		    if (methodSection) {
		        methodSection.style.display = 'none';
		    }
		}

		// åœ¨é¡µé¢åˆå§‹åŒ–æ—¶ç¡®ä¿method-sectionéšè—
		document.addEventListener('DOMContentLoaded', function() {
		    const methodSection = document.querySelector('.method-section');
		    if (methodSection) {
		        methodSection.style.display = 'none';
		    }
		    
		    const qrButton = document.getElementById('qr-code-button');
		    qrButton.addEventListener('click', generateRideLink);
		    
		    // è¯·æ±‚çˆ¶çª—å£å‘é€æ•°æ®
		    window.parent.postMessage({ type: 'requestData' }, '*');
		});

        // ç”Ÿæˆä¹˜è½¦é“¾æ¥
        async function generateRideLink() {
            let qrButton;
            
            try {
                qrButton = document.getElementById('qr-code-button');
                qrButton.disabled = true;
                qrButton.innerHTML = 'â³ ç”Ÿæˆä¸­...';

                hideError();
                hideSuccessMessage();
                showLoading();

                console.log('å½“å‰parentData:', parentData);

                // éªŒè¯æ•°æ®
                if (!parentData.startStation || !parentData.endStation) {
                    throw new Error('è¯·å…ˆåœ¨ä¸»é¡µé¢å¡«å†™èµ·å§‹ç«™ç‚¹å’Œç›®çš„ç«™ç‚¹');
                }

                if (!parentData.customer || !parentData.customer.id) {
                    throw new Error('å®¢æˆ·ä¿¡æ¯æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜');
                }

                if (parentData.customer.rideCount <= 0) {
                    throw new Error('æ‚¨çš„æ¬¡å¡æ¬¡æ•°å·²ç”¨å®Œï¼Œæ— æ³•ä½¿ç”¨äºŒç»´ç ä¹˜è½¦');
                }

                console.log('å‘é€è¯·æ±‚æ•°æ®:', {
                    customerId: parentData.customer.id,
                    startStation: parentData.startStation,
                    endStation: parentData.endStation
                });

                // è°ƒç”¨åç«¯APIç”Ÿæˆä¹˜è½¦é“¾æ¥
                const response = await fetch('/api/vip/generate-ride-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerId: parentData.customer.id,
                        startStation: parentData.startStation,
                        endStation: parentData.endStation
                    })
                });

                console.log('å“åº”çŠ¶æ€:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTPé”™è¯¯å“åº”:', errorText);
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('å“åº”ç»“æœ:', result);

                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const cardUrl = result.cardUrl || result.rideUrl;
                    showSuccessMessage(cardUrl);

                    // æ›´æ–°å®¢æˆ·æ¬¡æ•°
                    if (result.remainingRides !== undefined) {
                        parentData.customer.rideCount = result.remainingRides;
                        // é€šçŸ¥çˆ¶çª—å£æ›´æ–°æ˜¾ç¤º
                        window.parent.postMessage({
                            type: 'updateRideCount',
                            rideCount: result.remainingRides
                        }, '*');
                    }

                    // éšè—äºŒç»´ç æŒ‰é’®ï¼Œé¿å…é‡å¤ä½¿ç”¨
                    qrButton.style.display = 'none';

                } else {
                    throw new Error(result.message || 'ç”Ÿæˆä¹˜è½¦é“¾æ¥å¤±è´¥');
                }

            } catch (error) {
                console.error('ç”Ÿæˆä¹˜è½¦é“¾æ¥å¤±è´¥:', error);
                showError('ç”Ÿæˆä¹˜è½¦é“¾æ¥å¤±è´¥: ' + error.message);
                
                // é‡æ–°å¯ç”¨æŒ‰é’®
                if (qrButton) {
                    qrButton.disabled = false;
                    qrButton.innerHTML = 'ğŸ“± ç‚¹å‡»äºŒç»´ç ä¹˜è½¦';
                }
                hideLoading();
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const qrButton = document.getElementById('qr-code-button');
            qrButton.addEventListener('click', generateRideLink);
            
            // è¯·æ±‚çˆ¶çª—å£å‘é€æ•°æ®
            window.parent.postMessage({ type: 'requestData' }, '*');
        });

        // ä»çˆ¶çª—å£æ¥æ”¶æ•°æ®
		// åœ¨iframeçš„æ¶ˆæ¯ç›‘å¬ä¸­æ·»åŠ 
		window.addEventListener('message', function(event) {
		    console.log('æ”¶åˆ°çˆ¶çª—å£æ¶ˆæ¯:', event.data);
		    
		    if (event.data.type === 'sendData') {
		        // æ¥æ”¶çˆ¶çª—å£å‘é€çš„æ•°æ®
		        parentData = {
		            ...parentData,
		            ...event.data.data
		        };
		        console.log('æ¥æ”¶åˆ°çˆ¶çª—å£æ•°æ®:', parentData);
		        
		    } else if (event.data.type === 'showQRAlternative') {
		        // æ˜¾ç¤ºäºŒç»´ç å®¹å™¨
		        document.getElementById('qrAlternativeContainer').classList.remove('hidden');
		        // é‡ç½®æŒ‰é’®çŠ¶æ€
		        const qrButton = document.getElementById('qr-code-button');
		        qrButton.disabled = false;
		        qrButton.innerHTML = 'ğŸ“± ç‚¹å‡»äºŒç»´ç ä¹˜è½¦';
		        qrButton.style.display = 'flex';
		        hideError();
		        hideSuccessMessage();
		        hideLoading();
		        
		        // éšè—æ–¹æ³•è¯´æ˜åŒºåŸŸ
		        const methodSection = document.querySelector('.method-section');
		        if (methodSection) {
		            methodSection.style.display = 'none';
		        }
		        
		    } else if (event.data.type === 'hideQRAlternative') {
		        // éšè—äºŒç»´ç å®¹å™¨
		        document.getElementById('qrAlternativeContainer').classList.add('hidden');
		        
		    } else if (event.data.type === 'showQrSuccess') {
		        // æ˜¾ç¤ºå·²å­˜åœ¨çš„äºŒç»´ç æˆåŠŸçŠ¶æ€
		        document.getElementById('qrAlternativeContainer').classList.remove('hidden');
		        showSuccessMessage(event.data.qrUrl);
		        // éšè—æŒ‰é’®ï¼Œå› ä¸ºå·²ç»ç”Ÿæˆè¿‡äº†
		        const qrButton = document.getElementById('qr-code-button');
		        qrButton.style.display = 'none';
		        
		    } else if (event.data.type === 'hideQRButton') {
		        // æ–°å¢ï¼šéšè—æŒ‰é’®çš„ä¸“é—¨æ¶ˆæ¯
		        const qrButton = document.getElementById('qr-code-button');
		        qrButton.style.display = 'none';
		        
		    } else if (event.data.type === 'updateFormData') {
		        // æ›´æ–°è¡¨å•æ•°æ®
		        parentData.startStation = event.data.startStation || '';
		        parentData.endStation = event.data.endStation || '';
		        console.log('æ›´æ–°è¡¨å•æ•°æ®:', parentData);
		    }
		});
		
		// æ£€æŸ¥cardUrlå†…å®¹å¹¶é€šçŸ¥çˆ¶é¡µé¢
		function checkCardUrlContent() {
		    const cardUrlElement = document.getElementById('cardUrl');
		    const methodSection = document.querySelector('.method-section');
		    
		    if (cardUrlElement) {
		        const hasContent = cardUrlElement.textContent.trim().length > 0 || 
		                          cardUrlElement.innerHTML.trim().length > 0;
		        
		        // é€šçŸ¥çˆ¶é¡µé¢
		        window.parent.postMessage({
		            type: 'cardUrlContentStatus',
		            hasContent: hasContent
		        }, '*');
		        
		        // æœ¬åœ°ä¹Ÿè®¾ç½®å¯è§æ€§
		        if (methodSection) {
		            methodSection.style.display = hasContent ? 'block' : 'none';
		        }
		    }
		}

		// åœ¨DOMåŠ è½½å®Œæˆåæ£€æŸ¥
		document.addEventListener('DOMContentLoaded', function() {
		    // åˆå§‹æ£€æŸ¥
		    checkCardUrlContent();
		    
		    // ç›‘å¬å†…å®¹å˜åŒ–ï¼ˆMutationObserverï¼‰
		    const cardUrlElement = document.getElementById('cardUrl');
		    if (cardUrlElement) {
		        const observer = new MutationObserver(function(mutations) {
		            mutations.forEach(function(mutation) {
		                if (mutation.type === 'childList' || mutation.type === 'characterData') {
		                    checkCardUrlContent();
		                }
		            });
		        });
		        
		        observer.observe(cardUrlElement, {
		            childList: true,
		            characterData: true,
		            subtree: true
		        });
		    }
		});
		
        // è°ƒè¯•ä¿¡æ¯
        console.log('qrcode.html åŠ è½½å®Œæˆ');
		
		// åœ¨iframeçš„æ¶ˆæ¯ç›‘å¬ä¸­æ·»åŠ 
		// ä»çˆ¶çª—å£æ¥æ”¶æ•°æ®
		// ä»çˆ¶çª—å£æ¥æ”¶æ•°æ®
		window.addEventListener('message', function(event) {
		    console.log('æ”¶åˆ°çˆ¶çª—å£æ¶ˆæ¯:', event.data);
		    
		    if (event.data.type === 'sendData') {
		        // æ¥æ”¶çˆ¶çª—å£å‘é€çš„æ•°æ®
		        parentData = {
		            ...parentData,
		            ...event.data.data
		        };
		        console.log('æ¥æ”¶åˆ°çˆ¶çª—å£æ•°æ®:', parentData);
		        
		    } else if (event.data.type === 'showQRAlternative') {
		        // æ˜¾ç¤ºäºŒç»´ç å®¹å™¨
		        document.getElementById('qrAlternativeContainer').classList.remove('hidden');
		        // é‡ç½®æŒ‰é’®çŠ¶æ€
		        const qrButton = document.getElementById('qr-code-button');
		        qrButton.disabled = false;
		        qrButton.innerHTML = 'ğŸ“± ç‚¹å‡»äºŒç»´ç ä¹˜è½¦';
		        qrButton.style.display = 'flex';
		        hideError();
		        hideSuccessMessage();
		        hideLoading();
		        
		    } else if (event.data.type === 'hideQRAlternative') {
		        // éšè—äºŒç»´ç å®¹å™¨
		        document.getElementById('qrAlternativeContainer').classList.add('hidden');
		        
		    } else if (event.data.type === 'showQrSuccess') {
		        // æ˜¾ç¤ºå·²å­˜åœ¨çš„äºŒç»´ç æˆåŠŸçŠ¶æ€
		        document.getElementById('qrAlternativeContainer').classList.remove('hidden');
		        showSuccessMessage(event.data.qrUrl);
		        // éšè—æŒ‰é’®ï¼Œå› ä¸ºå·²ç»ç”Ÿæˆè¿‡äº†
		        const qrButton = document.getElementById('qr-code-button');
		        qrButton.style.display = 'none';
		        
		    } else if (event.data.type === 'hideQRButton') {
		        // æ–°å¢ï¼šéšè—æŒ‰é’®çš„ä¸“é—¨æ¶ˆæ¯
		        const qrButton = document.getElementById('qr-code-button');
		        qrButton.style.display = 'none';
		        
		    } else if (event.data.type === 'updateFormData') {
		        // æ›´æ–°è¡¨å•æ•°æ®
		        parentData.startStation = event.data.startStation || '';
		        parentData.endStation = event.data.endStation || '';
		        console.log('æ›´æ–°è¡¨å•æ•°æ®:', parentData);
		        
		    } else if (event.data.type === 'showMethodSection') {
		        // æ˜¾ç¤ºæ–¹æ³•è¯´æ˜åŒºåŸŸ
		        const methodSection = document.querySelector('.method-section');
		        if (methodSection) {
		            methodSection.style.display = 'block';
		        }
		        
		    } else if (event.data.type === 'hideMethodSection') {
		        // éšè—æ–¹æ³•è¯´æ˜åŒºåŸŸ
		        const methodSection = document.querySelector('.method-section');
		        if (methodSection) {
		            methodSection.style.display = 'none';
		        }
		    } else if (event.data.type === 'checkCardUrlContent') {
			    // çˆ¶é¡µé¢è¯·æ±‚æ£€æŸ¥cardUrlå†…å®¹
			    checkCardUrlContent();
			}
		});
		
    </script>
</body>
</html>