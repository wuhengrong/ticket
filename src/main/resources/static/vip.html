<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>次数信息</title>
    <style>
        /* 样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1, h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .user-info {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .ticket-info {
            margin-bottom: 15px;
        }
        
        .ticket-info p {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .card-details {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .status-available {
            background: #d4edda;
            color: #155724;
        }
        
        .status-in-use {
            background: #fff3cd;
            color: #856404;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:hover {
            background: #f9f9f9;
        }
        
        .no-tickets {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #3498db;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #fadbd8;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .time-suggestion {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .time-btn {
            flex: 1;
            background: #ecf0f1;
            border: none;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .time-btn:hover {
            background: #d5dbdb;
        }

        .card-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .info-label {
            font-size: 14px;
            opacity: 0.9;
            min-width: 80px;
            text-align: left;
        }

        .info-value {
            font-size: 16px;
            font-weight: bold;
            font-family: monospace;
            flex: 1;
            text-align: center;
            margin: 0 10px;
        }

        .copy-btn-small {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            min-width: 60px;
        }

        .copy-btn-small:hover {
            background: #8e44ad;
        }

        .user-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .ride-count {
            font-size: 18px;
            color: #e74c3c;
            font-weight: bold;
        }
		
		.toast {
		    position: fixed;
		    top: 20px;
		    left: 50%;
		    transform: translateX(-50%);
		    background: rgba(0, 0, 0, 0.8);
		    color: white;
		    padding: 12px 20px;
		    border-radius: 6px;
		    font-size: 14px;
		    z-index: 1000;
		    opacity: 0;
		    transition: opacity 0.3s;
		    pointer-events: none;
		}

		.toast.show {
		    opacity: 1;
		}

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }

        .time-btn.active {
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <!-- 错误提示 -->
    <div id="errorContainer" class="error hidden"></div>

    <!-- 用户信息显示 -->
    <div class="container" id="userInfoContainer">
        <div class="user-info">
            <h2>次卡信息</h2>
            <div class="user-name" id="vipCustomerName">-</div>
            <p>剩余乘车次数: <span class="ride-count" id="rideCount">-</span> 次</p>
        </div>
    </div>

    <!-- 票务查询 -->
    <div class="container" id="ticketQueryContainer">
        <h2>乘车票务查询</h2>
        
        <form id="ticketForm">
            <div class="form-group">
                <label for="startStation">起始站点</label>
                <input type="text" id="startStation" placeholder="输入或选择起始站点" list="stations">
                <datalist id="stations">
                    <option value="北京南站">
                    <option value="上海虹桥">
                    <option value="广州南站">
                    <option value="深圳北站">
                    <option value="福田站">
                    <option value="红山站">
                    <option value="马安山站">
                    <option value="科学馆站">
                    <option value="沙田站">
                    <option value="珠光站">
                </datalist>
            </div>
            
            <div class="form-group">
                <label for="endStation">目的站点</label>
                <input type="text" id="endStation" placeholder="输入或选择目的站点" list="stations">
            </div>
            
            <div class="form-group">
                <label for="travelTime">乘车时间</label>
                <input type="datetime-local" id="travelTime">
                <div class="time-suggestion">
                    <button type="button" class="time-btn" onclick="setTime('now')">现在</button>
                    <button type="button" class="time-btn" onclick="setTime('15min')">15分钟后</button>
                    <button type="button" class="time-btn" onclick="setTime('30min')">30分钟后</button>
                </div>
            </div>
            
            <button type="button" class="btn" id="searchBtn" onclick="searchTickets()">查询可用票</button>
        </form>

        <!-- 查询结果显示区域 -->
        <div id="searchResult" style="display: none;">
            <div class="card-display">
                <div class="card-title">为您找到最佳匹配票卡</div>
                
                <!-- 票卡号码行 -->
                <div class="info-row">
                    <span class="info-label">登录号</span>
                    <span class="info-value" id="displayCardNumber">-</span>
                    <button class="copy-btn-small" onclick="copyCardNumber()">复制</button>
                </div>
                
                <!-- 票卡密码行 -->
                <div class="info-row">
                    <span class="info-label">登录码</span>
                    <span class="info-value" id="displayCardPassword">-</span>
                    <button class="copy-btn-small" onclick="copyCardPassword()">复制</button>
                </div>
            </div>

            <button class="btn btn-success" id="useTicketBtn" onclick="useTicket()">使用此票卡</button>
        </div>
    </div>
    
    <!-- 当前使用中 -->
    <div class="container" id="inUseContainer">
        <h2>当前使用中</h2>
        <div class="status status-in-use">票务使用中</div>
        <div class="ticket-info">
            <div class="card-details">
                <p><strong>票卡号码：</strong><span id="currentCardNumber">-</span></p>
            </div>
            <p><strong>起始站：</strong><span id="currentStart">-</span></p>
            <p><strong>目的站：</strong><span id="currentEnd">-</span></p>
            <p><strong>乘车时间：</strong><span id="currentTime">-</span></p>
            <p><strong>预估出站时间：</strong><span id="currentEstimatedTime">-</span></p>
        </div>
        
        <button class="btn btn-danger" id="returnTicketBtn" onclick="returnTicket()">归还票卡</button>
        <div class="debug-info" id="returnDebugInfo" style="display: none;"></div>
    </div>
    
    <!-- 乘车历史 -->
    <div class="container" id="historyContainer">
        <h2>乘车历史记录</h2>
        <div id="historyList">
            <!-- 动态生成历史记录 -->
        </div>
    </div>

    <script>
        // 全局变量
        let currentTicket = null;
        let currentCustomer = null;
        let urlParams = {};
        let activeTicketInfo = null; // 新增：存储当前进行中的票务信息
        
        // 时区相关工具函数
		const timezoneUtils = {
		    // 获取当前北京时间
		    getBeijingTime() {
		        const now = new Date();
		        // 北京时间是 UTC+8
		        const beijingOffset = 8 * 60 * 60 * 1000;
		        // 获取本地时间与UTC的偏移（毫秒）
		        const localOffset = now.getTimezoneOffset() * 60 * 1000;
		        // 转换为北京时间：当前时间 + 本地偏移 + 8小时
		        return new Date(now.getTime() + localOffset + beijingOffset);
		    },
		    
		    // 将任意时间转换为北京时间
		    toBeijingTime(date) {
		        if (!date) return null;
		        const inputDate = new Date(date);
		        // 获取输入时间的时区偏移（分钟转毫秒）
		        const inputOffset = inputDate.getTimezoneOffset() * 60 * 1000;
		        // 北京时间偏移（UTC+8）
		        const beijingOffset = 8 * 60 * 60 * 1000;
		        // 转换为北京时间
		        return new Date(inputDate.getTime() + inputOffset + beijingOffset);
		    },
		    
		    // 将北京时间转换为本地时间（用于datetime-local输入）
		    beijingToLocal(date) {
		        if (!date) return null;
		        const beijingDate = new Date(date);
		        // 获取本地时区偏移（分钟转毫秒）
		        const localOffset = beijingDate.getTimezoneOffset() * 60 * 1000;
		        // 北京时间偏移（UTC+8）
		        const beijingOffset = 8 * 60 * 60 * 1000;
		        // 转换为本地时间：北京时间 - 8小时 + 本地偏移
		        return new Date(beijingDate.getTime() - beijingOffset + localOffset);
		    },
		    
		    // 格式化时间为datetime-local需要的格式 (YYYY-MM-DDTHH:mm)
		    formatForDateTimeLocal(date) {
		        if (!date) return '';
		        const d = new Date(date);
		        return `${d.getFullYear()}-${padZero(d.getMonth()+1)}-${padZero(d.getDate())}T${padZero(d.getHours())}:${padZero(d.getMinutes())}`;
		    }
		};

        // API调用函数
        const apiClient = {
            // 获取客户信息
            async getCustomerInfo(vipUrl) {
                try {
                    const response = await fetch(`/api/vip/customer/${encodeURIComponent(vipUrl)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('获取客户信息失败:', error);
                    throw error;
                }
            },
            
            // 搜索票卡
            async searchTickets(searchData) {
                try {
                    // 确保发送的时间是北京时间
                    if (searchData.boardingTime) {
                        // 将北京时间字符串转换为Date对象，然后转换为ISO字符串
                        const beijingTime = new Date(searchData.boardingTime);
                        searchData.boardingTime = beijingTime.toISOString();
                    }
                    
                    const response = await fetch('/api/vip/tickets/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(searchData)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('搜索票卡失败:', error);
                    throw error;
                }
            },
            
            // 使用票卡
            async useTicket(useData) {
                try {
                    const response = await fetch('/api/vip/tickets/use', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(useData)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('使用票卡失败:', error);
                    throw error;
                }
            },
            
            // 归还票卡
            async returnTicket(cardId, alightingStation, customerId) {
                try {
                    console.log('归还票卡请求参数:', {
                        cardId: cardId,
                        customerId: customerId,
                        alightingStation: alightingStation
                    });

                    const url = `/api/vip/tickets/return/${cardId}?alightingStation=${encodeURIComponent(alightingStation)}&customerId=${customerId}`;
                    console.log('请求URL:', url);

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    console.log('响应状态:', response.status);
                    
                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            const errorResponse = await response.json();
                            errorMessage = errorResponse.message || errorMessage;
                        } catch (e) {
                            // 忽略JSON解析错误
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const result = await response.json();
                    console.log('响应结果:', result);
                    return result;
                    
                } catch (error) {
                    console.error('归还票卡失败:', error);
                    throw error;
                }
            },

            // 新增：获取客户当前进行中的票务
            async getActiveTicket(customerId) {
                try {
                    const response = await fetch(`/api/vip/customer/${customerId}/active-ticket`);
                    if (!response.ok) {
                        // 如果没有进行中的票务，返回null而不是抛出错误
                        if (response.status === 404) {
                            return null;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('获取进行中票务失败:', error);
                    return null;
                }
            }
        };

        // 工具函数
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorContainer').classList.add('hidden');
        }

        function showDebugInfo(info) {
            const debugInfo = document.getElementById('returnDebugInfo');
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
        }

        function hideDebugInfo() {
            document.getElementById('returnDebugInfo').style.display = 'none';
        }

		// 修改 setTime 函数
		function setTime(type) {
		    let beijingTime;
		    
		    if (type === 'now') {
		        // 获取当前北京时间
		        beijingTime = timezoneUtils.getBeijingTime();
		        // 设置当前时间（增加5分钟缓冲）
		        beijingTime.setMinutes(beijingTime.getMinutes() + 5);
		    } else if (type === '15min') {
		        // 设置15分钟后（北京时间）
		        beijingTime = timezoneUtils.getBeijingTime();
		        beijingTime.setMinutes(beijingTime.getMinutes() + 15);
		    } else if (type === '30min') {
		        // 设置30分钟后（北京时间）
		        beijingTime = timezoneUtils.getBeijingTime();
		        beijingTime.setMinutes(beijingTime.getMinutes() + 30);
		    }
		    
		    // 直接将北京时间格式化为datetime-local需要的格式
		    // datetime-local 输入显示的是本地时间，但我们需要设置的是北京时间对应的本地时间值
		    const formatted = timezoneUtils.formatForDateTimeLocal(beijingTime);
		    
		    document.getElementById('travelTime').value = formatted;
		    
		    // 更新按钮激活状态
		    document.querySelectorAll('.time-btn').forEach(btn => {
		        btn.classList.remove('active');
		    });
		    
		    // 找到对应的按钮并激活
		    const buttons = document.querySelectorAll('.time-btn');
		    buttons.forEach(btn => {
		        if (btn.textContent === getButtonText(type)) {
		            btn.classList.add('active');
		        }
		    });
		}

		// 辅助函数：根据类型获取按钮文本
		function getButtonText(type) {
		    const textMap = {
		        'now': '现在',
		        '15min': '15分钟后',
		        '30min': '30分钟后'
		    };
		    return textMap[type] || type;
		}

        function formatDateTime(datetimeStr) {
            if (!datetimeStr) return '-';
            // 将服务器返回的时间转换为北京时间显示
            const beijingDate = timezoneUtils.toBeijingTime(datetimeStr);
            return `${beijingDate.getFullYear()}-${padZero(beijingDate.getMonth()+1)}-${padZero(beijingDate.getDate())} ${padZero(beijingDate.getHours())}:${padZero(beijingDate.getMinutes())}`;
        }

        function padZero(num) {
            return num < 10 ? '0' + num : num;
        }

		// 复制功能 - 使用Toast提示
		function copyCardNumber() {
		    const cardNumber = document.getElementById('displayCardNumber').textContent;
		    if (!cardNumber || cardNumber === '-') {
		        showToast('暂无卡号可复制');
		        return;
		    }
		    navigator.clipboard.writeText(cardNumber).then(() => {
		        showToast('卡号已复制到剪贴板');
		    }).catch(err => {
		        console.error('复制失败:', err);
		        showToast('复制失败，请重试');
		    });
		}

		function copyCardPassword() {
		    const cardPassword = document.getElementById('displayCardPassword').textContent;
		    if (!cardPassword || cardPassword === '-') {
		        showToast('暂无密码可复制');
		        return;
		    }
		    navigator.clipboard.writeText(cardPassword).then(() => {
		        showToast('密码已复制到剪贴板');
		    }).catch(err => {
		        console.error('复制失败:', err);
		        showToast('复制失败，请重试');
		    });
		}

		// Toast提示函数
		function showToast(message) {
		    // 创建或获取Toast元素
		    let toast = document.getElementById('toast');
		    if (!toast) {
		        toast = document.createElement('div');
		        toast.id = 'toast';
		        toast.style.cssText = `
		            position: fixed;
		            top: 20px;
		            left: 50%;
		            transform: translateX(-50%);
		            background: rgba(0, 0, 0, 0.8);
		            color: white;
		            padding: 12px 20px;
		            border-radius: 6px;
		            font-size: 14px;
		            z-index: 1000;
		            opacity: 0;
		            transition: opacity 0.3s;
		            pointer-events: none;
		        `;
		        document.body.appendChild(toast);
		    }
		    
		    toast.textContent = message;
		    toast.style.opacity = '1';
		    
		    // 2秒后自动隐藏
		    setTimeout(() => {
		        toast.style.opacity = '0';
		    }, 2000);
		}

        // 解析URL参数
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                uId: urlParams.get('uId'),
                gId: urlParams.get('gId'),
                code: urlParams.get('code')
            };
        }

        // 验证URL参数
        function validateUrlParams(params) {
            if (!params.uId || !params.gId || !params.code) {
                return false;
            }
            
            // 这里可以添加更复杂的验证逻辑，比如验证code是否有效
            // 暂时只做基础验证
            return params.uId.length > 0 && params.gId.length > 0 && params.code.length > 0;
        }

        // 构建VIP URL
        function buildVipUrl(uId, gId, code) {
            return `vip.html?uId=${uId}&gId=${gId}&code=${code}`;
        }

		// 初始化页面
		async function initializePage() {
		    try {
		        hideError();
		        hideDebugInfo();
		        
		        // 解析URL参数
		        urlParams = parseUrlParams();
		        
		        // 验证URL参数
		        if (!validateUrlParams(urlParams)) {
		            showError('无效的访问链接，请检查URL参数是否正确');
		            disableAllFeatures();
		            return;
		        }
		        
		        // 构建VIP URL用于API调用
		        const vipUrl = buildVipUrl(urlParams.uId, urlParams.gId, urlParams.code);
		        
		        // 获取客户信息
		        const customerData = await apiClient.getCustomerInfo(vipUrl);
		        
		        if (customerData && customerData.customer) {
		            currentCustomer = customerData.customer;
		            displayCustomerInfo(currentCustomer);
		            
		            // 显示历史记录
		            if (customerData.history) {
		                displayHistory(customerData.history);
		            }
		            
		            // 根据是否有进行中的票务显示对应界面
		            if (customerData.activeTicket && customerData.activeTicket.hasActiveTicket) {
		                // 有进行中的票务，显示归还界面
		                showInUseSection(customerData.activeTicket);
		            } else {
		                // 没有进行中的票务，显示查询界面
		                hideInUseSection();
		            }
		            
		        } else {
		            showError('无法获取客户信息，请检查URL参数');
		            disableAllFeatures();
		        }
		        
		    } catch (error) {
		        console.error('初始化页面失败:', error);
		        showError('页面初始化失败: ' + error.message);
		        disableAllFeatures();
		    }
		}

        // 显示客户信息
        function displayCustomerInfo(customer) {
            document.getElementById('vipCustomerName').textContent = customer.userName || '-';
            document.getElementById('rideCount').textContent = customer.rideCount || 0;
            
            // 根据次卡次数更新界面状态
            updateUIByRideCount(customer.rideCount);
        }

        // 根据次卡次数更新界面
        function updateUIByRideCount(rideCount) {
            const searchBtn = document.getElementById('searchBtn');
            
            if (rideCount <= 0) {
                searchBtn.disabled = true;
                searchBtn.textContent = '次卡次数不足';
                showError('您的次卡次数已用完，无法查询票务');
            } else {
                searchBtn.disabled = false;
                searchBtn.textContent = '查询可用票';
                hideError();
            }
        }

        // 显示历史记录
        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="no-tickets"><p>暂无乘车记录</p></div>';
                return;
            }
            
            let html = '';
            history.forEach(record => {
                const boardingTime = formatDateTime(record.boardingTime);
                const alightingTime = record.alightingTime ? formatDateTime(record.alightingTime) : '使用中';
                const status = record.alightingTime ? '已完成' : '进行中';
                
                html += `
                    <div class="history-item">
                        <p><strong>${record.boardingStation} → ${record.alightingStation || '未出站'}</strong></p>
                        <p>进站: ${boardingTime} | 出站: ${alightingTime}</p>
                        <p>状态: ${status}</p>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // 检查是否有正在使用的票卡
        async function checkActiveTicket() {
            if (!currentCustomer) return;
            
            try {
                // 调用API检查是否有正在使用的票卡
                const activeTicket = await apiClient.getActiveTicket(currentCustomer.id);
                
                if (activeTicket && activeTicket.success && activeTicket.activeTicket) {
                    activeTicketInfo = activeTicket.activeTicket;
                    showInUseSection(activeTicketInfo);
                } else {
                    hideInUseSection();
                }
            } catch (error) {
                console.error('检查进行中票务失败:', error);
                // 如果检查失败，默认显示查询界面
                hideInUseSection();
            }
        }

		// 显示使用中界面
		function showInUseSection(ticketInfo) {
		    // 隐藏查询界面
		    document.getElementById('ticketQueryContainer').style.display = 'none';
		    
		    // 显示使用中界面
		    document.getElementById('inUseContainer').style.display = 'block';
		    document.getElementById('historyContainer').style.display = 'block';
		    
		    // 填充票务信息
		    if (ticketInfo) {
		        document.getElementById('currentCardNumber').textContent = ticketInfo.cardNumber || '-';
		        document.getElementById('currentStart').textContent = ticketInfo.boardingStation || '-';
		        document.getElementById('currentEnd').textContent = ticketInfo.alightingStation || '-';
		        document.getElementById('currentTime').textContent = formatDateTime(ticketInfo.boardingTime) || '-';
		        document.getElementById('currentEstimatedTime').textContent = formatDateTime(ticketInfo.estimatedAlightingTime) || '-';
		        
		        // 设置当前票卡信息
		        currentTicket = {
		            id: ticketInfo.cardId,
		            cardNumber: ticketInfo.cardNumber,
		            cardPassword: ticketInfo.cardPassword
		        };
		    }
		}

		// 隐藏使用中界面
		function hideInUseSection() {
		    document.getElementById('ticketQueryContainer').style.display = 'block';
		    document.getElementById('inUseContainer').style.display = 'none';
		    document.getElementById('historyContainer').style.display = 'block';
		    
		    // 重置当前票卡信息
		    currentTicket = null;
		    activeTicketInfo = null;
		    
		    // 重置查询结果
		    hideSearchResult();
		}

        // 禁用所有功能
        function disableAllFeatures() {
            document.getElementById('ticketQueryContainer').style.display = 'none';
            document.getElementById('inUseContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'none';
        }

        // 显示查询结果
        function showSearchResult() {
            document.getElementById('searchResult').style.display = 'block';
        }

        // 隐藏查询结果
        function hideSearchResult() {
            document.getElementById('searchResult').style.display = 'none';
        }

		// 修改搜索功能中的时间处理
		async function searchTickets() {
		    const startStation = document.getElementById('startStation').value;
		    const endStation = document.getElementById('endStation').value;
		    const travelTime = document.getElementById('travelTime').value;
		    
		    if (!startStation || !endStation || !travelTime) {
		        showError('请填写完整的查询信息');
		        return;
		    }
		    
		    if (!currentCustomer) {
		        showError('客户信息未加载，请刷新页面重试');
		        return;
		    }
		    
		    try {
		        hideError();
		        hideSearchResult();
		        
		        // 显示加载状态
		        document.getElementById('searchBtn').disabled = true;
		        document.getElementById('searchBtn').textContent = '查询中...';
		        
		        // 将datetime-local的值直接作为北京时间处理
		        // 因为我们在设置时已经确保了它是北京时间
		        const beijingTime = new Date(travelTime);
		        
		        const searchData = {
		            boardingStation: startStation,
		            alightingStation: endStation,
		            boardingTime: beijingTime.toISOString(),
		            vipCustomerId: currentCustomer.id
		        };
		        
		        console.log('搜索参数:', searchData);
		        
		        const response = await apiClient.searchTickets(searchData);
		        
		        // 恢复按钮状态
		        document.getElementById('searchBtn').disabled = false;
		        document.getElementById('searchBtn').textContent = '查询可用票';
		        
		        if (response.success) {
		            currentTicket = response.matchedCard;
		            displayTicketResult(response);
		            showSearchResult();
		        } else {
		            showError(response.message || '查询失败，暂无可用票');
		        }
		    } catch (error) {
		        // 恢复按钮状态
		        document.getElementById('searchBtn').disabled = false;
		        document.getElementById('searchBtn').textContent = '查询可用票';
		        
		        showError('查询失败: ' + error.message);
		        console.error('搜索票务失败:', error);
		    }
		}
        // 显示票务结果
        function displayTicketResult(response) {
            const ticket = response.matchedCard;
            
            // 在卡片显示区域展示卡号和密码
            document.getElementById('displayCardNumber').textContent = ticket.cardNumber || '-';
            document.getElementById('displayCardPassword').textContent = ticket.cardPassword || '-';
        }

        // 使用票务
        async function useTicket() {
            if (!currentTicket || !currentCustomer) {
                showError('票务信息或客户信息不完整');
                return;
            }
            
            try {
                hideError();
                
                // 禁用按钮防止重复点击
                document.getElementById('useTicketBtn').disabled = true;
                document.getElementById('useTicketBtn').textContent = '处理中...';
                
                const useData = {
                    vipCustomerId: currentCustomer.id,
                    vipCardId: currentTicket.id,
                    boardingStation: document.getElementById('startStation').value,
                    alightingStation: document.getElementById('endStation').value
                };
                
                const response = await apiClient.useTicket(useData);
                
                if (response.success) {
                    // 更新客户信息
                    currentCustomer.rideCount = response.remainingRides;
                    displayCustomerInfo(currentCustomer);
                    
                    // 更新当前票卡信息
                    currentTicket = response.matchedCard;
                    
                    // 显示成功消息
					showToast('票卡使用成功！次卡次数已扣除');
                    
                    // 隐藏查询结果，切换到使用中界面
                    hideSearchResult();
                    
                    // 显示使用中界面
                    showInUseSection({
                        cardId: currentTicket.id,
                        cardNumber: currentTicket.cardNumber,
                        boardingStation: useData.boardingStation,
                        alightingStation: useData.alightingStation,
                        boardingTime: timezoneUtils.getBeijingTime().toISOString(), // 使用当前北京时间
                        estimatedAlightingTime: response.estimatedAlightingTime
                    });
                    
                } else {
                    showError('使用票务失败: ' + response.message);
                    // 恢复按钮状态
                    document.getElementById('useTicketBtn').disabled = false;
                    document.getElementById('useTicketBtn').textContent = '使用此票卡';
                }
            } catch (error) {
                console.error('使用票务失败:', error);
                showError('使用票务失败: ' + error.message);
                // 恢复按钮状态
                document.getElementById('useTicketBtn').disabled = false;
                document.getElementById('useTicketBtn').textContent = '使用此票卡';
            }
        }

		// 归还票卡
		async function returnTicket() {
		    if (!currentTicket || !currentCustomer) {
		        showError('没有正在使用的票卡或客户信息');
		        return;
		    }
		    
		    try {
		        hideError();
		        
		        // 禁用按钮防止重复点击
		        const returnBtn = document.getElementById('returnTicketBtn');
		        returnBtn.disabled = true;
		        returnBtn.textContent = '处理中...';
		        
		        // 使用目的站点作为出站点
		        const alightingStation = document.getElementById('currentEnd').textContent;
		        if (!alightingStation || alightingStation === '-') {
		            showError('出站点信息不完整');
		            returnBtn.disabled = false;
		            returnBtn.textContent = '归还票卡';
		            return;
		        }

		        const result = await apiClient.returnTicket(currentTicket.id, alightingStation, currentCustomer.id);
		        
		        if (result.success) {
		            showToast('票卡已成功归还！');
		            
		            // 隐藏使用中界面，显示查询界面
		            hideInUseSection();
		            hideSearchResult();
		            
		            // 重置表单
		            document.getElementById('ticketForm').reset();
		            setTime('now');
		            
		            // 刷新页面数据
		            await initializePage();
		            
		        } else {
		            showError('归还票卡失败: ' + result.message);
		            // 恢复按钮状态
		            returnBtn.disabled = false;
		            returnBtn.textContent = '归还票卡';
		        }
		    } catch (error) {
		        console.error('归还票卡失败:', error);
		        
		        // 显示详细的调试信息
		        const debugInfo = `请求详情:
		URL: /api/vip/tickets/return/${currentTicket?.id}
		参数: alightingStation=${document.getElementById('currentEnd').textContent}&customerId=${currentCustomer?.id}
		错误: ${error.message}`;
		        showDebugInfo(debugInfo);
		        
		        showError('归还票卡失败: ' + error.message);
		        // 恢复按钮状态
		        document.getElementById('returnTicketBtn').disabled = false;
		        document.getElementById('returnTicketBtn').textContent = '归还票卡';
		    }
		}

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认时间为北京时间
            setTime('now');
            
            // 初始化页面
            initializePage();
        });
    </script>
</body>
</html>