<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .tab {
            padding: 12px 24px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close:hover {
            color: #34495e;
        }
        
        .status-available { color: #27ae60; font-weight: 600; }
        .status-in-use { color: #f39c12; font-weight: 600; }
        .status-unavailable { color: #e74c3c; font-weight: 600; }
        .status-standby { color: #3498db; font-weight: 600; }
        
        .in-out-in { color: #2ecc71; font-weight: 600; }
        .in-out-out { color: #e74c3c; font-weight: 600; }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #3498db;
        }
        
        .error {
            background: #fadbd8;
            color: #e74c3c;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .empty-cell {
            color: #999;
            font-style: italic;
        }

        .record-status-in-progress { color: #f39c12; font-weight: 600; }
        .record-status-completed { color: #27ae60; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <h1>VIPå¡å’Œå®¢æˆ·ç®¡ç†ç³»ç»Ÿ</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('cards')">VIPå¡ç®¡ç†</button>
            <button class="tab" onclick="switchTab('customers')">å®¢æˆ·ç®¡ç†</button>
            <button class="tab" onclick="switchTab('records')">ä¹˜è½¦è®°å½•</button>
        </div>
        
        <!-- VIPå¡ç®¡ç† -->
        <div id="cards-tab" class="tab-content active">
            <div class="toolbar">
                <h2>VIPå¡ç®¡ç†</h2>
                <button class="btn" onclick="showCardModal()">æ–°å¢VIPå¡</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats" id="cards-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-cards">0</div>
                    <div class="stat-label">æ€»å¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="available-cards">0</div>
                    <div class="stat-label">å¯ç”¨å¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="in-use-cards">0</div>
                    <div class="stat-label">ä½¿ç”¨ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="standby-cards">0</div>
                    <div class="stat-label">å¤‡ç”¨å¡æ•°</div>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="card-search" placeholder="æœç´¢å¡å·ã€ç«™ç‚¹æˆ–çŠ¶æ€..." onkeyup="searchCards()">
                <select id="card-status-filter" onchange="filterCards()">
                    <option value="">æ‰€æœ‰çŠ¶æ€</option>
                    <option value="AVAILABLE">å¯ç”¨</option>
                    <option value="IN_USE">ä½¿ç”¨ä¸­</option>
                    <option value="UNAVAILABLE">ä¸å¯ç”¨</option>
                    <option value="STANDBY">å¤‡ç”¨</option>
                </select>
            </div>
            
            <div id="cards-message"></div>
            
            <div class="table-container">
                <table id="cards-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å·ç </th>
                            <th>å¡å¯†</th>
                            <th>çŠ¶æ€</th>
                            <th>é¦–æ¬¡ä½¿ç”¨æ—¶é—´</th>
                            <th>å¤±æ•ˆæ—¶é—´</th>
                            <th>è¿›ç«™æ—¶é—´</th>
                            <th>è¿›ç«™ç«™ç‚¹</th>
                            <th>å‡ºç«™æ—¶é—´</th>
                            <th>å‡ºç«™ç«™ç‚¹</th>
                            <th>è¿›å‡ºç«™</th>
                            <th>é¢„ä¼°å‡ºç«™æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="cards-tbody">
                        <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- å®¢æˆ·ç®¡ç† -->
        <div id="customers-tab" class="tab-content">
            <div class="toolbar">
                <h2>VIPå®¢æˆ·ç®¡ç†</h2>
                <button class="btn" onclick="showCustomerModal()">æ–°å¢å®¢æˆ·</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats" id="customers-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-customers">0</div>
                    <div class="stat-label">æ€»å®¢æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-customers">0</div>
                    <div class="stat-label">æœ‰æ¬¡æ•°å®¢æˆ·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="zero-count-customers">0</div>
                    <div class="stat-label">æ— æ¬¡æ•°å®¢æˆ·</div>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="customer-search" placeholder="æœç´¢ç”¨æˆ·åæˆ–ç»„å..." onkeyup="searchCustomers()">
            </div>
            
            <div id="customers-message"></div>
            
            <table id="customers-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç”¨æˆ·å</th>
						<th>æ˜µç§°</th>
                        <th>ç»„ID</th>
                        <th>ç»„å</th>
                        <th>æ¬¡å¡æ¬¡æ•°</th>
                        <th>VIPé“¾æ¥</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="customers-tbody">
                    <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
                </tbody>
            </table>
        </div>

        <!-- VIPè®°å½•ç®¡ç† -->
        <div id="records-tab" class="tab-content">
            <div class="toolbar">
                <h2>VIPä¹˜è½¦è®°å½•ç®¡ç†</h2>
                <button class="btn" onclick="showRecordModal()">æ–°å¢è®°å½•</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats" id="records-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-records">0</div>
                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="in-progress-records">0</div>
                    <div class="stat-label">è¿›è¡Œä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-records">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="record-search" placeholder="æœç´¢ç«™ç‚¹..." onkeyup="searchRecords()">
            </div>
            
            <div id="records-message"></div>
            
            <div class="table-container">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å®¢æˆ·ID</th>
                            <th>å®¢æˆ·å</th>
                            <th>æ˜µç§°</th>
                            <th>å¡ID</th>
                            <th>å¡å·</th>
                            <th>è¿›ç«™ç«™ç‚¹</th>
                            <th>å‡ºç«™ç«™ç‚¹</th>
                            <th>è¿›ç«™æ—¶é—´</th>
                            <th>å‡ºç«™æ—¶é—´</th>
                            <th>é¢„ä¼°å‡ºç«™æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- VIPå¡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="card-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="card-modal-title">æ–°å¢VIPå¡</h3>
                <span class="close" onclick="closeCardModal()">&times;</span>
            </div>
            <form id="card-form">
                <input type="hidden" id="card-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="card-number">å¡å· *</label>
                        <input type="text" id="card-number" required>
                    </div>
                    <div class="form-group">
                        <label for="card-password">å¯†ç  *</label>
                        <input type="text" id="card-password" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="card-status">çŠ¶æ€ *</label>
                        <select id="card-status" required>
                            <option value="AVAILABLE">å¯ç”¨</option>
                            <option value="IN_USE">ä½¿ç”¨ä¸­</option>
                            <option value="UNAVAILABLE">ä¸å¯ç”¨</option>
                            <option value="STANDBY">å¤‡ç”¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="card-expiry">å¤±æ•ˆæ—¶é—´</label>
                        <input type="datetime-local" id="card-expiry">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="card-first-use-time">é¦–æ¬¡ä½¿ç”¨æ—¶é—´</label>
                        <input type="datetime-local" id="card-first-use-time">
                    </div>
                    <div class="form-group">
                        <label for="card-boarding-time">è¿›ç«™æ—¶é—´</label>
                        <input type="datetime-local" id="card-boarding-time">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="card-boarding-station">è¿›ç«™ç«™ç‚¹</label>
                        <input type="text" id="card-boarding-station">
                    </div>
                    <div class="form-group">
                        <label for="card-alighting-time">å‡ºç«™æ—¶é—´</label>
                        <input type="datetime-local" id="card-alighting-time">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="card-alighting-station">å‡ºç«™ç«™ç‚¹</label>
                        <input type="text" id="card-alighting-station">
                    </div>
                    <div class="form-group">
                        <label for="card-in-out-status">è¿›å‡ºç«™çŠ¶æ€</label>
                        <select id="card-in-out-status">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="IN">è¿›ç«™</option>
                            <option value="OUT">å‡ºç«™</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="card-estimated-alighting-time">é¢„ä¼°å‡ºç«™æ—¶é—´</label>
                        <input type="datetime-local" id="card-estimated-alighting-time">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeCardModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- å®¢æˆ·ç¼–è¾‘æ¨¡æ€æ¡† -->
	<div id="customer-modal" class="modal">
	    <div class="modal-content">
	        <div class="modal-header">
	            <h3 id="customer-modal-title">æ–°å¢å®¢æˆ·</h3>
	            <span class="close" onclick="closeCustomerModal()">&times;</span>
	        </div>
	        <form id="customer-form">
	            <input type="hidden" id="customer-id">
	            <div class="form-row">
	                <div class="form-group">
	                    <label for="customer-username">ç”¨æˆ·å *</label>
	                    <input type="text" id="customer-username" required>
	                </div>
	                <div class="form-group">
	                    <label for="customer-nickname">æ˜µç§°</label>
	                    <input type="text" id="customer-nickname">
	                </div>
	            </div>
	            <div class="form-row">
	                <div class="form-group">
	                    <label for="customer-ridecount">æ¬¡å¡æ¬¡æ•° *</label>
	                    <input type="number" id="customer-ridecount" value="10" min="0" required>
	                </div>
	                <div class="form-group">
	                    <label for="customer-groupid">ç»„ID *</label>
	                    <input type="text" id="customer-groupid" required>
	                </div>
	            </div>
	            <div class="form-row">
	                <div class="form-group">
	                    <label for="customer-groupname">ç»„å</label>
	                    <input type="text" id="customer-groupname">
	                </div>
	            </div>
	            <div class="form-group">
	                <label for="customer-remark">å¤‡æ³¨</label>
	                <textarea id="customer-remark" rows="3"></textarea>
	            </div>
	            <div style="text-align: right; margin-top: 20px;">
	                <button type="submit" class="btn btn-success">ä¿å­˜</button>
	            </div>
	        </form>
	    </div>
	</div>
    
    <!-- å……å€¼æ¨¡æ€æ¡† -->
    <div id="recharge-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ¬¡å¡å……å€¼</h3>
                <span class="close" onclick="closeRechargeModal()">&times;</span>
            </div>
            <input type="hidden" id="recharge-customer-id">
            <div class="form-group">
                <label>å®¢æˆ·: <span id="recharge-customer-name"></span></label>
            </div>
            <div class="form-group">
                <label for="recharge-count">å……å€¼æ¬¡æ•° *</label>
                <input type="number" id="recharge-count" value="10" min="1" required>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn" onclick="closeRechargeModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="rechargeCustomer()">å……å€¼</button>
            </div>
        </div>
    </div>

    <!-- VIPè®°å½•ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="record-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="record-modal-title">æ–°å¢ä¹˜è½¦è®°å½•</h3>
                <span class="close" onclick="closeRecordModal()">&times;</span>
            </div>
            <form id="record-form">
                <input type="hidden" id="record-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="record-vip-customer-id">å®¢æˆ·ID *</label>
                        <input type="number" id="record-vip-customer-id" required>
                    </div>
                    <div class="form-group">
                        <label for="record-vip-card-id">å¡ID *</label>
                        <input type="number" id="record-vip-card-id" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="record-boarding-station">è¿›ç«™ç«™ç‚¹ *</label>
                        <input type="text" id="record-boarding-station" required>
                    </div>
                    <div class="form-group">
                        <label for="record-alighting-station">å‡ºç«™ç«™ç‚¹</label>
                        <input type="text" id="record-alighting-station">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="record-boarding-time">è¿›ç«™æ—¶é—´ *</label>
                        <input type="datetime-local" id="record-boarding-time" required>
                    </div>
                    <div class="form-group">
                        <label for="record-alighting-time">å‡ºç«™æ—¶é—´</label>
                        <input type="datetime-local" id="record-alighting-time">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="record-estimated-alighting-time">é¢„ä¼°å‡ºç«™æ—¶é—´</label>
                        <input type="datetime-local" id="record-estimated-alighting-time">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeRecordModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // APIå®¢æˆ·ç«¯
        const apiClient = {
            // VIPå¡ç›¸å…³API
            async getCards() {
                const response = await fetch('/api/admin/vip/cards');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async getCard(id) {
                const response = await fetch(`/api/admin/vip/cards/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async createCard(cardData) {
                const response = await fetch('/api/admin/vip/cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cardData)
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async updateCard(id, cardData) {
                const response = await fetch(`/api/admin/vip/cards/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cardData)
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async deleteCard(id) {
                const response = await fetch(`/api/admin/vip/cards/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return true;
            },
            
            // å®¢æˆ·ç›¸å…³API
            async getCustomers() {
                const response = await fetch('/api/admin/vip/customers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async getCustomer(id) {
                const response = await fetch(`/api/admin/vip/customers/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async createCustomer(customerData) {
                const response = await fetch('/api/admin/vip/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async updateCustomer(id, customerData) {
                const response = await fetch(`/api/admin/vip/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async deleteCustomer(id) {
                const response = await fetch(`/api/admin/vip/customers/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return true;
            },
            
            async rechargeCustomer(id, rideCount) {
                const response = await fetch(`/api/admin/vip/customers/${id}/recharge?rideCount=${rideCount}`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },

            // VIPè®°å½•ç›¸å…³API
            async getRecords() {
                const response = await fetch('/api/admin/vip/records');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async getRecord(id) {
                const response = await fetch(`/api/admin/vip/records/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async createRecord(recordData) {
                const response = await fetch('/api/admin/vip/records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordData)
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async updateRecord(id, recordData) {
                const response = await fetch(`/api/admin/vip/records/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordData)
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            },
            
            async deleteRecord(id) {
                const response = await fetch(`/api/admin/vip/records/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return true;
            },
            
            async searchRecords(keyword) {
                const response = await fetch(`/api/admin/vip/records/search?keyword=${encodeURIComponent(keyword)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            }
        };

        // å…¨å±€å˜é‡
        let allCards = [];
        let allCustomers = [];
        let allRecords = [];
        let currentEditingCard = null;
        let currentEditingCustomer = null;
        let currentEditingRecord = null;

        // å·¥å…·å‡½æ•°
        function formatDateTime(datetimeStr) {
            if (!datetimeStr) return '';
            try {
                return new Date(datetimeStr).toLocaleString('zh-CN');
            } catch (e) {
                return datetimeStr;
            }
        }

        function formatShortDateTime(datetimeStr) {
            if (!datetimeStr) return '<span class="empty-cell">-</span>';
            try {
                const date = new Date(datetimeStr);
                return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return datetimeStr;
            }
        }

        // ä¿®å¤æ—¶é—´æ ¼å¼è½¬æ¢å‡½æ•°ï¼Œç¡®ä¿ç¼–è¾‘æ¨¡æ€æ¡†ä¸­çš„æ—¶é—´æ ¼å¼æ­£ç¡®
        function formatDateTimeForInput(datetimeStr) {
            if (!datetimeStr) return '';
            try {
                const date = new Date(datetimeStr);
                // è·å–ä¸­å›½æ—¶åŒºæ—¶é—´
                const offset = date.getTimezoneOffset() * 60000;
                const localTime = new Date(date.getTime() - offset);
                return localTime.toISOString().slice(0, 16);
            } catch (e) {
                return '';
            }
        }

        function showMessage(elementId, message, type = 'error') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function getStatusText(status) {
            const statusMap = {
                'AVAILABLE': 'å¯ç”¨',
                'IN_USE': 'ä½¿ç”¨ä¸­',
                'UNAVAILABLE': 'ä¸å¯ç”¨',
                'STANDBY': 'å¤‡ç”¨'
            };
            return statusMap[status] || status;
        }

        function getInOutText(inOutStatus) {
            const inOutMap = {
                'IN': 'è¿›',
                'OUT': 'å‡º'
            };
            return inOutMap[inOutStatus] || inOutStatus;
        }

        function getInOutClass(inOutStatus) {
            const inOutClassMap = {
                'IN': 'in-out-in',
                'OUT': 'in-out-out'
            };
            return inOutClassMap[inOutStatus] || '';
        }

        function getRecordStatus(alightingTime) {
            return alightingTime ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
        }

        function getRecordStatusClass(alightingTime) {
            return alightingTime ? 'record-status-completed' : 'record-status-in-progress';
        }

        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // åŠ è½½æ•°æ®
            if (tabName === 'cards') {
                loadCards();
            } else if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'records') {
                loadRecords();
            }
        }

        // VIPå¡ç®¡ç†åŠŸèƒ½
        async function loadCards() {
            try {
                showMessage('cards-message', 'æ­£åœ¨åŠ è½½VIPå¡æ•°æ®...', 'success');
                allCards = await apiClient.getCards();
                displayCards(allCards);
                updateCardStats(allCards);
            } catch (error) {
                console.error('åŠ è½½VIPå¡å¤±è´¥:', error);
                showMessage('cards-message', 'åŠ è½½VIPå¡å¤±è´¥: ' + error.message);
            }
        }

        function displayCards(cards) {
            const tbody = document.getElementById('cards-tbody');
            tbody.innerHTML = '';
            
            if (cards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; color: #666;">æš‚æ— VIPå¡æ•°æ®</td></tr>';
                return;
            }
            
            cards.forEach(card => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${card.id}</td>
                    <td><strong>${card.cardNumber}</strong></td>
                    <td>${card.cardPassword}</td>
                    <td class="status-${card.status.toLowerCase()}">${getStatusText(card.status)}</td>
                    <td>${formatShortDateTime(card.firstUseTime)}</td>
                    <td>${formatShortDateTime(card.expiryTime)}</td>
                    <td>${formatShortDateTime(card.boardingTime)}</td>
                    <td>${card.boardingStation || '<span class="empty-cell">-</span>'}</td>
                    <td>${formatShortDateTime(card.alightingTime)}</td>
                    <td>${card.alightingStation || '<span class="empty-cell">-</span>'}</td>
                    <td class="${getInOutClass(card.inOutStatus)}">${getInOutText(card.inOutStatus) || '<span class="empty-cell">-</span>'}</td>
                    <td>${formatShortDateTime(card.estimatedAlightingTime)}</td>
                    <td class="action-buttons">
                        <button class="action-btn btn-warning" onclick="editCard(${card.id})">ç¼–è¾‘</button>
                        <button class="action-btn btn-danger" onclick="deleteCard(${card.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCardStats(cards) {
            const total = cards.length;
            const available = cards.filter(card => card.status === 'AVAILABLE').length;
            const inUse = cards.filter(card => card.status === 'IN_USE').length;
            const standby = cards.filter(card => card.status === 'STANDBY').length;
            
            document.getElementById('total-cards').textContent = total;
            document.getElementById('available-cards').textContent = available;
            document.getElementById('in-use-cards').textContent = inUse;
            document.getElementById('standby-cards').textContent = standby;
        }

        function searchCards() {
            const searchTerm = document.getElementById('card-search').value.toLowerCase();
            const statusFilter = document.getElementById('card-status-filter').value;
            
            let filteredCards = allCards;
            
            if (searchTerm) {
                filteredCards = filteredCards.filter(card => 
                    card.cardNumber.toLowerCase().includes(searchTerm) ||
                    (card.boardingStation && card.boardingStation.toLowerCase().includes(searchTerm)) ||
                    (card.alightingStation && card.alightingStation.toLowerCase().includes(searchTerm)) ||
                    getStatusText(card.status).toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredCards = filteredCards.filter(card => card.status === statusFilter);
            }
            
            displayCards(filteredCards);
        }

        function filterCards() {
            searchCards();
        }

        function showCardModal() {
            currentEditingCard = null;
            document.getElementById('card-modal-title').textContent = 'æ–°å¢VIPå¡';
            document.getElementById('card-form').reset();
            document.getElementById('card-id').value = '';
            document.getElementById('card-status').value = 'AVAILABLE';
            document.getElementById('card-in-out-status').value = '';
            document.getElementById('card-modal').style.display = 'block';
        }

        function closeCardModal() {
            document.getElementById('card-modal').style.display = 'none';
        }

        async function editCard(id) {
            try {
                const card = await apiClient.getCard(id);
                currentEditingCard = card;
                
                document.getElementById('card-modal-title').textContent = 'ç¼–è¾‘VIPå¡';
                document.getElementById('card-id').value = card.id;
                document.getElementById('card-number').value = card.cardNumber;
                document.getElementById('card-password').value = card.cardPassword;
                document.getElementById('card-status').value = card.status;
                document.getElementById('card-expiry').value = formatDateTimeForInput(card.expiryTime);
                document.getElementById('card-first-use-time').value = formatDateTimeForInput(card.firstUseTime);
                document.getElementById('card-boarding-time').value = formatDateTimeForInput(card.boardingTime);
                document.getElementById('card-boarding-station').value = card.boardingStation || '';
                document.getElementById('card-alighting-time').value = formatDateTimeForInput(card.alightingTime);
                document.getElementById('card-alighting-station').value = card.alightingStation || '';
                document.getElementById('card-in-out-status').value = card.inOutStatus || '';
                document.getElementById('card-estimated-alighting-time').value = formatDateTimeForInput(card.estimatedAlightingTime);
                
                document.getElementById('card-modal').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½VIPå¡è¯¦æƒ…å¤±è´¥:', error);
                showMessage('cards-message', 'åŠ è½½VIPå¡è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        async function deleteCard(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ VIPå¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const success = await apiClient.deleteCard(id);
                if (success) {
                    showMessage('cards-message', 'åˆ é™¤æˆåŠŸ', 'success');
                    await loadCards();
                } else {
                    showMessage('cards-message', 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤VIPå¡å¤±è´¥:', error);
                showMessage('cards-message', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        document.getElementById('card-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const cardData = {
                cardNumber: document.getElementById('card-number').value.trim(),
                cardPassword: document.getElementById('card-password').value.trim(),
                status: document.getElementById('card-status').value,
                expiryTime: document.getElementById('card-expiry').value || null,
                firstUseTime: document.getElementById('card-first-use-time').value || null,
                boardingTime: document.getElementById('card-boarding-time').value || null,
                boardingStation: document.getElementById('card-boarding-station').value.trim() || null,
                alightingTime: document.getElementById('card-alighting-time').value || null,
                alightingStation: document.getElementById('card-alighting-station').value.trim() || null,
                inOutStatus: document.getElementById('card-in-out-status').value || null,
                estimatedAlightingTime: document.getElementById('card-estimated-alighting-time').value || null
            };
            
            if (!cardData.cardNumber || !cardData.cardPassword) {
                showMessage('cards-message', 'è¯·å¡«å†™å®Œæ•´çš„å¡å·å¯†ç ');
                return;
            }
            
            try {
                if (currentEditingCard) {
                    await apiClient.updateCard(currentEditingCard.id, cardData);
                    showMessage('cards-message', 'æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    await apiClient.createCard(cardData);
                    showMessage('cards-message', 'åˆ›å»ºæˆåŠŸ', 'success');
                }
                
                closeCardModal();
                await loadCards();
            } catch (error) {
                console.error('ä¿å­˜VIPå¡å¤±è´¥:', error);
                showMessage('cards-message', 'æ“ä½œå¤±è´¥: ' + error.message);
            }
        });

        // å®¢æˆ·ç®¡ç†åŠŸèƒ½
        async function loadCustomers() {
            try {
                showMessage('customers-message', 'æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...', 'success');
                allCustomers = await apiClient.getCustomers();
                displayCustomers(allCustomers);
                updateCustomerStats(allCustomers);
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
                showMessage('customers-message', 'åŠ è½½å®¢æˆ·å¤±è´¥: ' + error.message);
            }
        }

		// ä¿®æ”¹åçš„displayCustomerså‡½æ•°
		function displayCustomers(customers) {
		    const tbody = document.getElementById('customers-tbody');
		    tbody.innerHTML = '';
		    
		    if (customers.length === 0) {
		        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">æš‚æ— å®¢æˆ·æ•°æ®</td></tr>';
		        return;
		    }
		    
		    customers.forEach(customer => {
		        const row = document.createElement('tr');
		        row.innerHTML = `
		            <td>${customer.id}</td>
		            <td>${customer.userName}</td>
		            <td>${customer.nickName || '<span class="empty-cell">-</span>'}</td>
		            <td>${customer.groupId}</td>
		            <td>${customer.groupName || '-'}</td>
		            <td>${customer.rideCount}</td>
		            <td>
		                ${customer.vipUrl ? 
		                    `<a href="${customer.vipUrl}" target="_blank" title="ç‚¹å‡»è®¿é—®VIPé¡µé¢" style="color: #3498db; text-decoration: none;">ğŸ”— è®¿é—®</a>` : 
		                    '-'
		                }
		            </td>
		            <td>${formatDateTime(customer.createdTime)}</td>
		            <td class="action-buttons">
		                <button class="action-btn btn-warning" onclick="editCustomer(${customer.id})">ç¼–è¾‘</button>
		                <button class="action-btn btn-success" onclick="showRechargeModal(${customer.id}, '${customer.userName}')">å……å€¼</button>
		            </td>
		        `;
		        tbody.appendChild(row);
		    });
		}

        function updateCustomerStats(customers) {
            const total = customers.length;
            const active = customers.filter(customer => customer.rideCount > 0).length;
            const zeroCount = customers.filter(customer => customer.rideCount === 0).length;
            
            document.getElementById('total-customers').textContent = total;
            document.getElementById('active-customers').textContent = active;
            document.getElementById('zero-count-customers').textContent = zeroCount;
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            
            const filteredCustomers = allCustomers.filter(customer => 
                customer.userName.toLowerCase().includes(searchTerm) ||
                (customer.groupName && customer.groupName.toLowerCase().includes(searchTerm)) ||
                customer.groupId.toString().includes(searchTerm)
            );
            
            displayCustomers(filteredCustomers);
        }

        function showCustomerModal() {
            currentEditingCustomer = null;
            document.getElementById('customer-modal-title').textContent = 'æ–°å¢å®¢æˆ·';
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            document.getElementById('customer-ridecount').value = 10;
            document.getElementById('customer-modal').style.display = 'block';
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').style.display = 'none';
        }

        async function editCustomer(id) {
            try {
                const customer = await apiClient.getCustomer(id);
                currentEditingCustomer = customer;
                
                document.getElementById('customer-modal-title').textContent = 'ç¼–è¾‘å®¢æˆ·';
                document.getElementById('customer-id').value = customer.id;
                document.getElementById('customer-username').value = customer.userName;
				document.getElementById('customer-nickname').value = customer.nickName || '';
                document.getElementById('customer-ridecount').value = customer.rideCount;
                document.getElementById('customer-groupid').value = customer.groupId;
                document.getElementById('customer-groupname').value = customer.groupName || '';
                document.getElementById('customer-remark').value = customer.remark || '';
                
                document.getElementById('customer-modal').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥:', error);
                showMessage('customers-message', 'åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        async function deleteCustomer(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const success = await apiClient.deleteCustomer(id);
                if (success) {
                    showMessage('customers-message', 'åˆ é™¤æˆåŠŸ', 'success');
                    await loadCustomers();
                } else {
                    showMessage('customers-message', 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å®¢æˆ·å¤±è´¥:', error);
                showMessage('customers-message', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        document.getElementById('customer-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const customerData = {
                userName: document.getElementById('customer-username').value.trim(),
				nickName: document.getElementById('customer-nickname').value.trim(),
                rideCount: parseInt(document.getElementById('customer-ridecount').value),
                groupId: document.getElementById('customer-groupid').value.trim(),
                groupName: document.getElementById('customer-groupname').value.trim(),
                remark: document.getElementById('customer-remark').value.trim()
            };
            
            if (!customerData.userName || !customerData.groupId) {
                showMessage('customers-message', 'è¯·å¡«å†™ç”¨æˆ·åå’Œç»„ID');
                return;
            }
            
            if (isNaN(customerData.rideCount) || customerData.rideCount < 0) {
                showMessage('customers-message', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¬¡å¡æ¬¡æ•°');
                return;
            }
            
            try {
                if (currentEditingCustomer) {
                    await apiClient.updateCustomer(currentEditingCustomer.id, customerData);
                    showMessage('customers-message', 'æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    await apiClient.createCustomer(customerData);
                    showMessage('customers-message', 'åˆ›å»ºæˆåŠŸ', 'success');
                }
                
                closeCustomerModal();
                await loadCustomers();
            } catch (error) {
                console.error('ä¿å­˜å®¢æˆ·å¤±è´¥:', error);
                showMessage('customers-message', 'æ“ä½œå¤±è´¥: ' + error.message);
            }
        });

        // å……å€¼åŠŸèƒ½
        function showRechargeModal(customerId, customerName) {
            document.getElementById('recharge-customer-id').value = customerId;
            document.getElementById('recharge-customer-name').textContent = customerName;
            document.getElementById('recharge-count').value = 10;
            document.getElementById('recharge-modal').style.display = 'block';
        }

        function closeRechargeModal() {
            document.getElementById('recharge-modal').style.display = 'none';
        }

        async function rechargeCustomer() {
            const customerId = document.getElementById('recharge-customer-id').value;
            const rideCount = parseInt(document.getElementById('recharge-count').value);
            
            if (!rideCount || rideCount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼æ¬¡æ•°');
                return;
            }
            
            try {
                await apiClient.rechargeCustomer(customerId, rideCount);
                showMessage('customers-message', 'å……å€¼æˆåŠŸ', 'success');
                closeRechargeModal();
                await loadCustomers();
            } catch (error) {
                console.error('å……å€¼å¤±è´¥:', error);
                showMessage('customers-message', 'å……å€¼å¤±è´¥: ' + error.message);
            }
        }

        // VIPè®°å½•ç®¡ç†åŠŸèƒ½
        async function loadRecords() {
            try {
                showMessage('records-message', 'æ­£åœ¨åŠ è½½ä¹˜è½¦è®°å½•...', 'success');
                allRecords = await apiClient.getRecords();
                displayRecords(allRecords);
                updateRecordStats(allRecords);
            } catch (error) {
                console.error('åŠ è½½ä¹˜è½¦è®°å½•å¤±è´¥:', error);
                showMessage('records-message', 'åŠ è½½ä¹˜è½¦è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        function displayRecords(records) {
            const tbody = document.getElementById('records-tbody');
            tbody.innerHTML = '';
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; color: #666;">æš‚æ— ä¹˜è½¦è®°å½•</td></tr>';
                return;
            }
            
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${record.vipCustomerId}</td>
                    <td>${record.customerName || '<span class="empty-cell">-</span>'}</td>
                    <td>${record.customerNickName || '<span class="empty-cell">-</span>'}</td>
                    <td>${record.vipCardId}</td>
                    <td>${record.cardNumber || '<span class="empty-cell">-</span>'}</td>
                    <td>${record.boardingStation}</td>
                    <td>${record.alightingStation || '<span class="empty-cell">-</span>'}</td>
                    <td>${formatShortDateTime(record.boardingTime)}</td>
                    <td>${formatShortDateTime(record.alightingTime)}</td>
                    <td>${formatShortDateTime(record.estimatedAlightingTime)}</td>
                    <td class="${getRecordStatusClass(record.alightingTime)}">${getRecordStatus(record.alightingTime)}</td>
                    <td>${formatShortDateTime(record.createdTime)}</td>
                    <td class="action-buttons">
                        <button class="action-btn btn-warning" onclick="editRecord(${record.id})">ç¼–è¾‘</button>
                        <button class="action-btn btn-danger" onclick="deleteRecord(${record.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRecordStats(records) {
            const total = records.length;
            const inProgress = records.filter(record => !record.alightingTime).length;
            const completed = records.filter(record => record.alightingTime).length;
            
            document.getElementById('total-records').textContent = total;
            document.getElementById('in-progress-records').textContent = inProgress;
            document.getElementById('completed-records').textContent = completed;
        }

        function searchRecords() {
            const searchTerm = document.getElementById('record-search').value.trim();
            
            if (!searchTerm) {
                displayRecords(allRecords);
                return;
            }
            
            try {
                apiClient.searchRecords(searchTerm).then(filteredRecords => {
                    displayRecords(filteredRecords);
                });
            } catch (error) {
                console.error('æœç´¢è®°å½•å¤±è´¥:', error);
                showMessage('records-message', 'æœç´¢å¤±è´¥: ' + error.message);
            }
        }

        function showRecordModal() {
            currentEditingRecord = null;
            document.getElementById('record-modal-title').textContent = 'æ–°å¢ä¹˜è½¦è®°å½•';
            document.getElementById('record-form').reset();
            document.getElementById('record-id').value = '';
            document.getElementById('record-modal').style.display = 'block';
        }

        function closeRecordModal() {
            document.getElementById('record-modal').style.display = 'none';
        }

        async function editRecord(id) {
            try {
                const record = await apiClient.getRecord(id);
                currentEditingRecord = record;
                
                document.getElementById('record-modal-title').textContent = 'ç¼–è¾‘ä¹˜è½¦è®°å½•';
                document.getElementById('record-id').value = record.id;
                document.getElementById('record-vip-customer-id').value = record.vipCustomerId;
                document.getElementById('record-vip-card-id').value = record.vipCardId;
                document.getElementById('record-boarding-station').value = record.boardingStation;
                document.getElementById('record-alighting-station').value = record.alightingStation || '';
                document.getElementById('record-boarding-time').value = formatDateTimeForInput(record.boardingTime);
                document.getElementById('record-alighting-time').value = formatDateTimeForInput(record.alightingTime);
                document.getElementById('record-estimated-alighting-time').value = formatDateTimeForInput(record.estimatedAlightingTime);
                
                document.getElementById('record-modal').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½è®°å½•è¯¦æƒ…å¤±è´¥:', error);
                showMessage('records-message', 'åŠ è½½è®°å½•è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        async function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä¹˜è½¦è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const success = await apiClient.deleteRecord(id);
                if (success) {
                    showMessage('records-message', 'åˆ é™¤æˆåŠŸ', 'success');
                    await loadRecords();
                } else {
                    showMessage('records-message', 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                showMessage('records-message', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        document.getElementById('record-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const recordData = {
                vipCustomerId: parseInt(document.getElementById('record-vip-customer-id').value),
                vipCardId: parseInt(document.getElementById('record-vip-card-id').value),
                boardingStation: document.getElementById('record-boarding-station').value.trim(),
                alightingStation: document.getElementById('record-alighting-station').value.trim() || null,
                boardingTime: document.getElementById('record-boarding-time').value,
                alightingTime: document.getElementById('record-alighting-time').value || null,
                estimatedAlightingTime: document.getElementById('record-estimated-alighting-time').value || null
            };
            
            if (!recordData.vipCustomerId || !recordData.vipCardId || !recordData.boardingStation || !recordData.boardingTime) {
                showMessage('records-message', 'è¯·å¡«å†™å®Œæ•´çš„å¿…å¡«å­—æ®µ');
                return;
            }
            
            try {
                if (currentEditingRecord) {
                    await apiClient.updateRecord(currentEditingRecord.id, recordData);
                    showMessage('records-message', 'æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    await apiClient.createRecord(recordData);
                    showMessage('records-message', 'åˆ›å»ºæˆåŠŸ', 'success');
                }
                
                closeRecordModal();
                await loadRecords();
            } catch (error) {
                console.error('ä¿å­˜è®°å½•å¤±è´¥:', error);
                showMessage('records-message', 'æ“ä½œå¤±è´¥: ' + error.message);
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadCards();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>